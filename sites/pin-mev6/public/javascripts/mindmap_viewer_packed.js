pie.drag.Simple=Class.create(pie.drag.Base,{onInit:function(){},beforeStart:function(){this.ileft=parseInt(this.el.style.left||0);this.itop=parseInt(this.el.style.top||0)},onDragging:function(){this.el.setStyle({top:this.itop+this.distanceY+"px",left:this.ileft+this.distanceX+"px"})},beforeFinish:function(){}});
pie.drag.Page=Class.create(pie.drag.Base,{onInit:function(){this.beforeDrag=this._config.beforeDrag||function(){}},isReady:function(){if(this.evtel.tagName=="INPUT"||this.evtel.tagName=="TEXTAREA")return false},beforeStart:function(){this.beforeDrag();this.parent=this.el.parentNode;this.scrollX=this.parent.scrollLeft;this.scrollY=this.parent.scrollTop},onDragging:function(){var a=this.scrollX-this.distanceX,b=this.scrollY-this.distanceY;this.parent.scrollLeft=a;this.parent.scrollTop=b;this.xoff=a;
this.yoff=b}});pie.mindmap=pie.mindmap||{};
pie.mindmap.Node=Class.create({initialize:function(a,b){a=a||{};Object.extend(this,a);if(this.revision!=null){this.root=this;this.map=b;this.revision=this.revision||0;this.map.revision={local:this.revision,remote:this.revision}}else{this.parent=b;this.root=b.root;this.map=this.root.map;this.sub=this.parent.is_root()?this:this.parent.sub}this.canvas={};this.branch={};this.top=this.left=0;var c=[];this.children.each(function(g,f){var h=new pie.mindmap.Node(g,this);if(f>0){h.prev=c[f-1];c[f-1].next=
h}h.index=f;c.push(h)}.bind(this));this.children=c;this.dirty=true;try{this.map.nodes.set(this.id,this)}catch(d){alert(d)}this._build_container_dom()},simple_format:function(a){return a.escapeHTML().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;").replace(/>$/,">&nbsp;")},set_title:function(a){a=a==""?" ":a;this.nodetitle.jq.html(this.simple_format(a));this.title=a.replace(/\r\n/g,"\n")},formated_title:function(){return this.simple_format(this.title)},escaped_note:function(){return jQuery.string(this.note).escapeHTML().str.gsub("\n",
"<br/>")},cache_dimensions:function(){if(this.width==null){Object.extend(this,this.el.getDimensions());this.children.each(function(a){a.cache_dimensions()}.bind(this))}},_bindCommonEvents:function(){this.el.makeUnselectable();this.el.observe("mouseover",function(){this.el.addClassName("over")}.bind(this)).observe("mouseout",function(){this.el.removeClassName("over")}.bind(this));var a=this.folder.el;a.observe("mouseover",function(){a.addClassName("over")}.bind(this)).observe("mouseout",function(){a.removeClassName("over")}.bind(this)).observe("click",
this.toggle.bind(this));this.el.observe("click",function(b){Event.isLeftClick(b)&&this.is_selected()&&this.map.edit_focus_title();this.select()}.bind(this)).observe("contextmenu",function(){this.select()}.bind(this));pie.isIE()&&this.map.editmode&&this.el.observe("dblclick",function(){this.map.edit_focus_title()}.bind(this));this.map.editmode&&this!=this.root&&new pie.drag.PinNode(this)},_bindShowEvents:function(){this.is_note_blank()||jQuery(this.el).tipsy({html:true,gravity:jQuery.fn.tipsy.autoS,
title:function(){return this.escaped_note()}.bind(this)})},_bindEditEvents:function(){this.map.editmode&&this.map.nodeMenu&&this.map.nodeMenu.bind(this.el,"bottom",this)},select:function(a){var b=this.map;if(this.is_being_edit)return false;if(b.focus){b.stop_edit_focus_title();b.focus.el.removeClassName("selected")}b.focus=this;this.el.addClassName("selected");a||b.__scrollto(this);if(b.editmode){b.nodeMenu.unload();b._node_note_editor.show_note(this)}return this},getPrevCousin:function(){var a=this,
b=0;do{for(var c=a;c=c.prev;)if(c.sub.pos==a.sub.pos)break;if(c){for(;b>0;){b--;if(c.children.length>0&&!c.closed)c=c.children.last()}return c}b++}while(a=a.parent);return this},getNextCousin:function(){var a=this,b=0;do{for(var c=a;c=c.next;)if(c.sub.pos==a.sub.pos)break;if(c){for(;b>0;){b--;if(c.children.length>0&&!c.closed)c=c.children.first()}return c}b++}while(a=a.parent);return this},__tidyChildren:function(){this.children.each(function(a,b){a.index=b;a.prev=b>0?this.children[b-1]:null;a.next=
b<this.children.length-1?this.children[b+1]:null;a.container.top=0}.bind(this))},__changesub:function(a){this.sub.dirty=true;this.sub=a;this.children.each(function(b){b.__changesub(a)}.bind(this));this.sub.dirty=true},hilight:function(a){this.nodebody.jq.css("background-color",a)},do_dirty:function(){if(!this.is_root())this.sub.dirty=true},is_root:function(){return this==this.root},put_on_right:function(){return this.pos=="right"||this.pos==null},is_selected:function(){return this.el.hasClassName("selected")},
is_note_blank:function(){return this.note==""||this.note=="<br>"||this.note=="<br/>"||this.note=="<br />"},get_bgcolor:function(){return this.bgcolor},get_textcolor:function(){return this.textcolor},set_bgcolor:function(a,b){this.bgcolor=a;this.textcolor=b;jQuery(this.el).css("background-color",a);this.nodetitle.jq.css("color",b)},re_rank:function(){Object.extend(this,this.el.getDimensions());this.do_dirty();this.map.reRank()}});
pie.mindmap_node_build_dom_module={_build_container_dom:function(){try{if(this.el==null){this.__build_nodeimage();this.__build_noteicon();this.__build_nodetitle();this.__build_nodebody();this.__build_node();this.folder={id:"f_"+this.id,el:$(Builder.node("div",{"class":this.closed?"foldhandler plus":"foldhandler minus",style:"position:absolute;"+(this.children.length==0?"display:none;":"")}))};this.content={id:"children_"+this.id,top:0,el:$(Builder.node("div",{"class":"mindmap-children",style:"position:absolute"}))};
this.children.each(function(b){this.content.el.insert(b.container.el)}.bind(this));this.container={id:"c_"+this.id,top:0,el:$(Builder.node("div",{"class":"mindmap-container",style:"position:absolute"},this.maxid!=null?[this.el,this.content.el]:[this.el,this.folder.el,this.content.el]))};this._bindCommonEvents();this.map.editmode?this._bindEditEvents():this._bindShowEvents()}}catch(a){alert(a)}return this.container.el},__build_nodeimage:function(){if(this.image)this.image.jq=jQuery("<div class='node-image'></div>").css("background-image",
"url('"+this.image.url+"')").css("height",this.image.height).css("width",this.image.width)},__build_noteicon:function(){this.noteicon={};if(!this.is_note_blank())this.noteicon.jq=jQuery("<div class='note-icon'></div>")},__build_nodetitle:function(){this.nodetitle={jq:jQuery("<div class='nodetitle'></div>").html(this.formated_title())}},__build_nodebody:function(){this.nodebody={jq:jQuery("<div class='nodebody'></div>").append(this.nodetitle.jq).append(this.noteicon.jq)}},__build_node:function(){var a=
jQuery("<div></div>").attr("id",this.id).addClass(this.is_root()?"root":"node").css("background-color",this.bgcolor).css("color",this.textcolor);this.image&&a.append(this.image.jq);a.append(this.nodebody.jq);this.jq=a;this.el=$(a[0])}};pie.mindmap.Node.addMethods(pie.mindmap_node_build_dom_module);pie.mindmap_canvas_draw_module={connect:{},_connectWithDiv:function(){},_drawOnCanvas:function(a){a.canvas.el=$(a.canvas.id);var b=a.canvas.el.getContext("2d");b.strokeStyle=this.lineColor;this._connectWithCanvas_recursion(a,b)},_connectWithCanvas_recursion:function(a,b){var c=this.__getNodePosition(a);b.beginPath();b.moveTo(c.left,c.bottom);b.lineTo(c.right,c.bottom);b.stroke();a.closed||a.children.each(function(d){this._connectWithCanvas_recursion(d,b);b.beginPath();b.moveTo(c.right,c.bottom);b.bezierCurveTo(c.right,
c.bottom,c.right,d.canvas.bottom,d.canvas.left,d.canvas.bottom);b.stroke()}.bind(this))},__getNodePosition:function(a){var b=a.top.round(),c=b+a.height,d,g;d=a.sub.put_on_right()?a.left:a.right;g=d+a.width+this.foldhandler_width/2;if(a.sub!=a){var f=a.parent.content,h=a.container.top+a.parent.canvas.top-(a.parent.top-f.top).round();b+=h;c+=h;f=a.sub.put_on_right()?f.left+a.parent.canvas.left:f.right+a.container.width-a.parent.canvas.left;d+=f;g+=f}if(!a.sub.put_on_right()){d=a.container.width-d;g=
a.container.width-g}a.canvas.top=b;a.canvas.bottom=c;a.canvas.left=d;a.canvas.right=g;return{top:b,right:g,bottom:c,left:d}},_drawOnBranch:function(a){if(!a.free){a.branch.el=$(a.branch.id);var b=a.branch.el.getContext("2d");b.fillStyle=this.lineColor;b.strokeStyle=this.lineColor;this._connect_root_with_canvas(a,b)}},_connect_root_with_canvas:function(a,b){try{var c=pie.mindmap,d=a.sub.put_on_right(),g=a.branch.type==0;(new (d?g?c.RootBranchCanvasRUP:c.RootBranchCanvasRDOWN:g?c.RootBranchCanvasLUP:
c.RootBranchCanvasLDOWN)(a,b)).draw()}catch(f){alert(f)}}};
pie.mindmap.RootBranchCanvasBase=Class.create({initialize:function(a,b){this.map=a.map;this.branch=a.branch;this.ctx=b;this.lw=5;this.p2=Math.PI*2;this.rr=2;this.canvas_overflow=this.map.canvas_overflow;this.qcoff=a.sub.put_on_right()?this.branch.width/3:-this.branch.width/3},draw:function(){this._count_point();var a=this.ctx;a.beginPath();this._draw_connect_line(a);a.stroke();a.fill();a.beginPath();this._draw_arc(a);a.fill()},_draw_connect_line:function(a){a.moveTo(this.x1,this.y1);a.quadraticCurveTo(this.xn-
this.qcoff,this.yn,this.xn,this.yn);a.quadraticCurveTo(this.xn-this.qcoff,this.yn,this.x2,this.y1)},_draw_arc:function(a){a.arc(this.xn,this.yn,this.rr,0,this.p2,true)}});pie.mindmap.RootBranchCanvasRUP=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=0;this.x2=this.lw;this.y1=this.branch.height+this.canvas_overflow;this.xn=this.branch.width-this.rr;this.yn=this.canvas_overflow}});
pie.mindmap.RootBranchCanvasRDOWN=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=0;this.x2=this.lw;this.y1=this.canvas_overflow;this.xn=this.branch.width-this.rr;this.yn=this.branch.height+this.canvas_overflow}});pie.mindmap.RootBranchCanvasLUP=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=this.branch.width;this.x2=this.branch.width-this.lw;this.y1=this.branch.height+this.canvas_overflow;this.xn=this.rr;this.yn=this.canvas_overflow}});
pie.mindmap.RootBranchCanvasLDOWN=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=this.branch.width;this.x2=this.branch.width-this.lw;this.y1=this.canvas_overflow;this.xn=this.rr;this.yn=this.branch.height+this.canvas_overflow}});pie.mindmap_node_modifying_methods={createNewSibling:function(){var a=this.map;if(!a._pause())if(!this.is_root()){var b=a.mr_factory.data_insert(false,this.index+1,this.parent);b.select();b=a.opFactory.getInsertInstance(b);a._save(b)}},createNewChild:function(){var a=this.map;if(!a._pause()){var b=a.mr_factory.data_insert(false,this.children.length,this);b.select();b=a.opFactory.getInsertInstance(b);a._save(b)}},remove:function(){var a=this.map;if(!a._pause())if(!this.is_root()){a.mr_factory.data_remove(false,
this);if(this.next)this.next.select();else this.prev?this.prev.select():this.parent.select();var b=a.opFactory.getDeleteInstance(this);a._save(b)}},set_title_and_save:function(a){try{var b=this.map;b.mr_factory.data_title(false,this,a);this.select();if(this.title!=this._oldtitle){var c=b.opFactory.getTitleInstance(this);b._save(c)}}catch(d){alert(d)}},set_image_and_save:function(a){try{var b=this.map;b.mr_factory.data_image(false,this,a);this.select();var c=b.opFactory.getImageInstance(this);b._save(c)}catch(d){alert(d)}},
remove_image_and_save:function(){try{var a=this.map;a.mr_factory.data_remove_image(false,this);this.select();var b=a.opFactory.getRemoveImageInstance(this);a._save(b)}catch(c){alert(c)}},set_note_and_save:function(a){var b=this.map;b.mr_factory.data_note(false,this,a);this.select();a=b.opFactory.getNoteInstance(this);b._save(a)}};
pie.mindmap_node_new_child_methods={_newChild:function(a,b){var c=this.__build_child_hash(b);this.__add_to_children(c,a);this.__add_to_html_dom(c);this.is_root()||this.folder.el.show();c.sub.dirty=true;this.map.nodes.set(c.id,c);return c},__build_child_hash:function(a){a={image:null,closed:false,note:"",children:[],title:"NewSubNode",pos:"right",id:a||pie.randstr()};if(this.is_root()){var b=this.children,c=$A(b).select(function(d){return d.sub.pos=="left"}).length;b=b.length-c;pie.log(b,c);if(b>c+
1)a.pos="left"}return new pie.mindmap.Node(a,this)},__add_to_children:function(a,b){var c=this.children.slice(0,b),d=this.children.slice(b);a.prev=c.last();if(a.prev)a.prev.next=a;a.next=d.first();if(a.next)a.next.prev=a;c.push(a);this.children=c.concat(d);this.children.each(function(g,f){g.index=f}.bind(this))},__add_to_html_dom:function(a){var b=a.container.el,c;if(a.prev){c=this.is_root()?a.prev.canvas.el:a.prev.container.el;c.insert({after:b})}else{c=this.content.el;c.insert({bottom:b})}a.cache_dimensions()}};
pie.mindmap_node_remove_child_methods={_remove:function(){try{var a=this.parent;this.container.el.remove();a.children=a.children.without(this);a.__tidyChildren();if(a.is_root()){this.canvas.el.remove();this.branch.el.remove()}else a.children.length==0&&a.folder.el.hide();this.sub.dirty=true;this.map.nodes.unset(this.id)}catch(b){alert(b)}return this}};
pie.mindmap_node_toggle_methods={toggle:function(a){var b=this.map;if(!(!a&&b._pause())){this._toggle();this.sub.dirty=true;b.reRank();if(b.editmode){a=b.opFactory.getToggleInstance(this);b._save(a)}}},_toggle:function(){this.closed?this._expand():this._collapse();this.content.el.toggle()},_expand:function(){this.folder.el.className="foldhandler minus";this.closed=false},_collapse:function(){var a=this.map.focus;if(a)for(;a!=this.root;){if(a.parent==this){this.select();break}a=a.parent}this.folder.el.className=
"foldhandler plus";this.closed=true}};pie.mindmap.Node.addMethods(pie.mindmap_node_modifying_methods).addMethods(pie.mindmap_node_new_child_methods).addMethods(pie.mindmap_node_toggle_methods).addMethods(pie.mindmap_node_remove_child_methods);pie.mindmap=pie.mindmap||{};
pie.mindmap.BasicMapPaper=Class.create({initialize:function(a,b){b=b||{};Object.extend(this,b);this.editmode=b.editmode==true;this._init_paper(a);this._init_scroller();this._init_toolbar();this._init_const();this.nodes=new Hash;this.editmode&&this._createMenu()},_init_paper:function(a){this.paper={jq:jQuery(a)}},_init_scroller:function(){this.scroller={jq:this.paper.jq.parent()}},_init_toolbar:function(){if(this.editmode){var a=jQuery(".mindmap-paper-toolbar");this.toolbar={jq:a,undo_jq:a.find(".mindmap-ops .mindmap-undo"),
redo_jq:a.find(".mindmap-ops .mindmap-redo")}}},_init_const:function(){this.log=pie.log;this.pause_period=500;this.foldhandler_width=11;this.canvas_overflow=6;this.lineColor="#5c5c5c";if(this.editmode){this._node_title_editor=new pie.mindmap.NodeTitleEditor(this);this._node_image_editor=new pie.mindmap.NodeImageEditor(this);this._node_note_editor=new pie.mindmap.NodeNoteEditor(this);this._node_color_editor=new pie.mindmap.NodeColorEditor(this);this.opFactory=new pie.mindmap.OperationRecordFactory({map:this});
this.mr_factory=new pie.mindmap.ModifyingResponseFactory({map:this})}this.connect=this._connectWithCanvas},load:function(){jQuery.ajax({url:this.data_url,type:"GET",dataType:"json",success:function(a){this.root=new pie.mindmap.Node(a,this);this.initial_data({recenter:true})}.bind(this),error:function(){jQuery.facebox("\u601d\u7ef4\u5bfc\u56fe\u6570\u636e\u5f02\u5e38\uff0c\u8f7d\u5165\u5931\u8d25\u3002")}});return this},undo_load:function(){return this._undo_or_redo_load("undo")},redo_load:function(){return this._undo_or_redo_load("redo")},
_undo_or_redo_load:function(a){var b="";if(a=="undo")b="/mindmaps/"+this.id+"/undo";if(a=="redo")b="/mindmaps/"+this.id+"/redo";if(b=="")return this;var c=this;jQuery.ajax({url:b,type:"PUT",dataType:"json",beforeSend:function(){jQuery(".ajax-loading-bar").css("display","block");c.toolbar.undo_jq.addClass("lock");c.toolbar.redo_jq.addClass("lock")},success:function(d){pie.log(d);this.root=new pie.mindmap.Node(d.map,this);this.initial_data({recenter:false});d.can_undo&&this.toolbar.undo_jq.removeClass("lock");
d.can_redo&&this.toolbar.redo_jq.removeClass("lock")}.bind(this),error:function(){jQuery.facebox("\u601d\u7ef4\u5bfc\u56fe\u6570\u636e\u5f02\u5e38\uff0c\u8f7d\u5165\u5931\u8d25\u3002")},complete:function(){jQuery(".ajax-loading-bar").css("display","none")}});return this},initial_data:function(a){var b=this.paper,c=this.root,d=b.jq;this.el=c.container.el;d.html(this.el);c.cache_dimensions();b.xoff=d.width()/2;b.yoff=d.height()/2;a.recenter==true&&this.recenter();this._set_root_position();this.reRank();
new pie.drag.Page(b.jq[0],{beforeDrag:function(){if(this.editmode){this.nodeMenu.unload();this.stop_edit_focus_title()}}.bind(this)});this._bindHotkeyDispatcher();this.root.select()},recenter:function(){try{var a=this.scroller.jq;a.scrollLeft(this.paper.xoff-a.width()/2);a.scrollTop(this.paper.yoff-a.height()/2)}catch(b){alert(b)}},_set_root_position:function(){var a=this.paper,b=this.root;b.posX=(0-b.width)/2+a.xoff;b.posY=(0-b.height)/2+a.yoff;jQuery(b.container.el).css("left",b.posX).css("top",
b.posY);b.container.el.style.top=b.posY+"px"},__prepare_canvas_for_ie:function(){typeof G_vmlCanvasManager!="undefined"&&G_vmlCanvasManager.init_(document)},reRank:function(){var a=new Date;this.root.children.each(function(c){c.dirty&&this.setCoord(c)}.bind(this));this.setRootCoord(this.root);var b=new Date;pie.log("\u6392\u5217.."+(b-a)+"ms");a=new Date;this.root.children.each(function(c){c.dirty&&this.connect(c);this._connectWithCanvas_branch(c)}.bind(this));this.__prepare_canvas_for_ie();this.root.el.style.zIndex=
"101";this.root.children.each(function(c){if(c.dirty){this._drawOnCanvas(c);c.dirty=false}this._drawOnBranch(c)}.bind(this));b=new Date;this.log("\u753b\u7ebf.."+(b-a)+"ms");this.posRegister=this._updatePosRegister(this.root)},setCoord:function(a){var b=this.foldhandler_width,c=0,d=0;a.closed?Element.hide(a.content.el):a.children.each(function(m){c+=this.setCoord(m);m=m.container.width;if(m>d)d=m}.bind(this));var g=a.width,f=a.height,h=a.container,i=a.content,j=a.folder,e=0;e=0;var k,l;if(c==0){e=
f;a.top=0;i.top=0}else if(f>c){k=a.children.first();e=a.children.last().container;l=a.children.last();k=k.top+k.height;e=e.top+l.top+l.height;e=f-(k+e)/2;i.top=e;a.top=0;e=e+c}else if(f<c){k=a.children.first();e=a.children.last().container;l=a.children.last();k=k.top+k.height;e=e.top+l.top+l.height;e=(k+e)/2-f;i.top=0;a.top=e>0?e:0;e=c}else{e=c;a.top=0;i.top=0}i.height=c;i.width=d;if(a.sub.put_on_right()){i.left=g+b;j.left=g;i.el.style.left=i.left+"px";j.el.style.left=j.left+"px";i.el.style.right=
"";j.el.style.right="";a.el.style.right="";h.el.style.right=""}else{i.right=g+b;j.right=g;a.right=0;h.right=0;i.el.style.right=i.right+"px";j.el.style.right=j.right+"px";a.el.style.right=a.right+"px";h.el.style.right=h.right+"px";i.el.style.left="";j.el.style.left=""}j.top=f-b/2+a.top;h.height=e;h.width=g+b+a.content.width;if(b=a.prev){b.container||this.log(b.title+"****");if(a.parent!=this.root){h.top=b.container.top+b.container.height+10;e+=10}else if(a.free){h.el.style.left=a.freeX+"px";h.top=
b.container.top+b.container.height-a.top+10;h.el.style.top=a.freeY-a.top+"px"}}h.el.style.height=h.height+"px";h.el.style.width=h.width+"px";if(a.free!=true)h.el.style.top=h.top+"px";i.el.style.height=i.height+"px";i.el.style.width=i.width+"px";i.el.style.top=i.top+"px";j.el.style.top=j.top+"px";a.el.style.top=a.top+"px";return e},setRootCoord:function(a){Element.makeUnselectable(a.el);a.top=a.el.offsetTop;a.left=a.el.offsetLeft;var b=a.left+(a.width+50),c=-10,d=-10;a.children.each(function(j){if(!j.free){var e=
j.container;if(j.put_on_right()){e.left=b;c+=e.height+10}else{e.left=a.left*2+a.width-b-e.width;d+=e.height+10}e.el.style.left=e.left+"px"}}.bind(this));var g=a.height,f=a.top,h=f-(c-g)/2,i=f-(d-g)/2;a.children.each(function(j){var e=j.container;if(!j.free){if(j.put_on_right()){e.top=h;h+=e.height+10}else{e.top=i;i+=e.height+10}e.el.style.top=e.top+"px"}j=j.canvas;j.el&&j.el.clonePosition(e.el,{setWidth:false,setHeight:false})}.bind(this))},_connectWithCanvas:function(a){var b=a.canvas.el;if(!b){Element.setStyle(a.container.el,
{zIndex:"101"});a.canvas.id="canvas_"+a.id;b=Builder.node("canvas",{id:a.canvas.id});$(b).setStyle({zIndex:"100",position:"absolute",border:"solid 0px"});Element.insert(a.container.el,{after:b});b.clonePosition(a.container.el,{setWidth:false,setHeight:false})}a.canvas.width=a.container.width;a.canvas.height=a.container.height+this.canvas_overflow;b.setAttribute("width",a.canvas.width);b.setAttribute("height",a.canvas.height)},_connectWithCanvas_branch:function(a){if(a.free){if(a.branch.el){Element.remove(a.branch.el);
a.branch={}}}else{this.__countBranch(a);var b=a.branch.el;if(!b){a.branch.id="branch_"+a.id;b=Builder.node("canvas",{id:a.branch.id});$(b).setStyle({zIndex:"100",position:"absolute",border:"solid 0px"});a.container.el.insert({after:b})}b.setAttribute("width",a.branch.width);b.setAttribute("height",a.branch.height+this.canvas_overflow*2);b.setStyle({left:a.branch.left+"px",top:a.branch.top-this.canvas_overflow*2+"px"})}},__countBranch:function(a){if(a.sub.put_on_right()){a.branch.left=a.root.left+
a.root.width/2;a.branch.width=a.container.left-a.branch.left}else{a.branch.left=a.container.left+a.container.width;a.branch.width=a.root.left+a.root.width/2-a.branch.left}if(a.container.top+a.top+a.height<a.root.top+a.root.height/2){a.branch.top=(a.container.top+a.top+a.height).round();a.branch.height=a.root.top+a.root.height/2-a.branch.top;a.branch.type=0}else{a.branch.top=a.root.top+a.root.height/2;a.branch.height=(a.container.top+a.top+a.height-a.branch.top).round();a.branch.type=1}a.branch.top+=
this.canvas_overflow},_updatePosRegister:function(a){$A(document.getElementsByName("postemp")).each(Element.remove);var b=new Hash,c=a.left+this.root.posX,d=a.top+this.root.posY;b.set(a.id,[a,c,d,c+a.width,d+a.height]);a.children.each(function(g){this._updatePosRegister_recursion(g,b)}.bind(this));return b},_updatePosRegister_recursion:function(a,b){var c,d,g,f;d=a.canvas.top+a.sub.container.top-a.top+this.root.posY;g=a.width;f=a.container.height;c=a.canvas.left+a.sub.container.left+this.root.posX;
a.sub.put_on_right()||(c-=a.width);b.set(a.id,[a,c,d,c+g,d+f]);a.closed||a.children.each(function(h){this._updatePosRegister_recursion(h,b)}.bind(this))},__setTempBox:function(a,b,c,d){this.posbox=Builder.node("div",{name:"postemp",style:"position:absolute; background-color:#E8641B;border-top:solid 5px #DF0024;border-bottom:solid 5px #DF0024;"});Element.setStyle(this.posbox,{left:a+"px",top:b+"px",width:c+"px",height:d+"px",opacity:0.3,zIndex:103});this.paper.jq.append(this.posbox)},_bindHotkeyDispatcher:function(){document.stopObserving("keydown",
window._hotkeyDispatcher);window._hotkeyDispatcher=this.hotkeyDispatcher.bind(this);document.observe("keydown",window._hotkeyDispatcher)},hotkeyDispatcher:function(a){if(!(!this.focus||this.focus.is_being_edit)){var b=Event.element(a).tagName;if(pie.isIE()){this.log(b);if(b!="DIV")return}else if(b!="HTML"&&b!="BODY")return;b=a.keyCode;if(!this.is_on_note_edit_status){Event.stop(a);switch(b){case Event.KEY_UP:this._up();break;case Event.KEY_DOWN:this._down();break;case Event.KEY_LEFT:this._left();
break;case Event.KEY_RIGHT:this._right();break}if(this.editmode)switch(b){case Event.KEY_RETURN:this.focus.createNewSibling();break;case 45:this.focus.createNewChild();break;case 46:this.focus.remove();break;case 32:this.edit_focus_title();break;case 73:this.edit_focus_image();break}}}},_up:function(){var a=this.focus;if(a!=a.root){a.getPrevCousin().select();this.log("up:"+a.id)}else a.children.each(function(b){if(b.put_on_right()){b.select();throw $break;}}.bind(this))},_down:function(){var a=this.focus;
if(a!=a.root){a.getNextCousin().select();this.log("down:"+a.id)}else a.children.reverse(false).each(function(b){if(b.put_on_right()){b.select();throw $break;}}.bind(this))},_left:function(){var a=this.focus;if(a!=a.root)if(a.sub.put_on_right()){a.parent.select();this.log("left:"+a.id)}else{if(!a.closed)if(a.children.first()){a.children[((0+a.children.length-1)/2).floor()].select();this.log("left:"+a.id)}}else a.children.each(function(b){if(!b.put_on_right()){b.select();throw $break;}}.bind(this))},
_right:function(){var a=this.focus;if(a!=a.root)if(a.sub.put_on_right()){if(!a.closed)if(a.children.first()){a.children[((0+a.children.length-1)/2).floor()].select();this.log("left:"+a.id)}}else{a.parent.select();this.log("left:"+a.id)}else a.children.each(function(b){if(b.put_on_right()){b.select();throw $break;}}.bind(this))},__scrollto:function(a){if(a.el.visible()){var b=this.scroller.jq,c=b.width(),d=b.height(),g=b.offset(),f=jQuery(a.el).offset(),h=0;if(f.left<g.left)h=f.left-g.left;else{var i=
f.left+a.width;c=g.left+c-20;if(i>c)h=i-c}i=0;if(f.top<g.top)i=f.top-g.top;else{a=f.top+a.height;d=g.top+d-20;if(a>d)i=a-d}if(h!=0||i!=0)b.animate({scrollLeft:"+="+h,scrollTop:"+="+i},400)}},_pause:function(a){if(this.pause==true)return true;else{this.pause=true;a=a||this.pause_period;setTimeout(function(){this.pause=false}.bind(this),a);return false}}});
pie.mindmap_focus_methods={edit_focus_image:function(){this._can_edit_focus()&&this._node_image_editor.do_edit_image(this.focus)},edit_focus_note:function(){this._can_edit_focus()&&this._node_note_editor.do_edit_note(this.focus)},edit_focus_color:function(){this._can_edit_focus()&&this._node_color_editor.do_edit_font(this.focus)},edit_focus_title:function(){this._can_edit_focus()&&this._node_title_editor.do_edit(this.focus)},stop_edit_focus_title:function(){this.focus&&this.focus.is_being_edit&&this._node_title_editor.stop_edit()},
_can_edit_focus:function(){return this.editmode&&this.focus}};pie.mindmap.BasicMapPaper.addMethods(pie.mindmap_canvas_draw_module).addMethods(pie.mindmap_menu_module).addMethods(pie.mindmap_save_module).addMethods(pie.mindmap_cooprate_response_module).addMethods(pie.mindmap_focus_methods);
