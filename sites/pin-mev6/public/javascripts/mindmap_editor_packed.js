var MpAccordion=Class.create({initialize:function(a,b,c){this.elements=$A(b);this.togglers=$A(a);this.setOptions(c);this.togglers.each(function(d,e){d.prevClick=d.onclick?d.onclick:function(){};$(d).onclick=function(){d.prevClick();this.show_or_hide(e)}.bind(this)}.bind(this))},setOptions:function(a){this.options=a||{};this.options=Object.extend({unfold_bgc:"#ff0000"},this.options)},show_or_hide:function(a){var b=this.elements[a];if(b.offsetHeight==b.scrollHeight)this.hide_el(a);else b.offsetHeight==
0&&this.show_el(a)},show_el:function(a){var b=this.elements[a];a=this.togglers[a];this.change_el_height(b,b.scrollHeight);b=a.getAttribute("data-active-bgc");this.change_title_color(a,b);a.addClassName("open").removeClassName("close")},hide_el:function(a){var b=this.togglers[a];this.change_el_height(this.elements[a],0);this.change_title_color(b,b.getAttribute("data-bgc"));b.removeClassName("open").addClassName("close")},change_title_color:function(a,b){b!=null&&new Effect.Morph(a,{style:{backgroundColor:b},
duration:0.1})},change_el_height:function(a,b){new Effect.Morph(a,{style:{height:b+"px"},duration:0.3})}});pie.load(function(){$$(".mpaccordion-bar").each(function(a){var b=a.select(".mpaccordion-toggler");a=a.select(".mpaccordion-content");new MpAccordion(b,a,{})}.bind(this))});pie.drag={};
pie.drag.Base=Class.create({initialize:function(a,b){this.el=$(a);this._config=b;this.onInit();this.mdh=this.mouseDownHandle.bindAsEventListener(this);this.mmh=this.mouseMoveHandle.bindAsEventListener(this);this.muh=this.mouseUpHandle.bindAsEventListener(this);this.el.observe("mousedown",this.mdh)},mouseDownHandle:function(a){this.evtel=a.element();if(this.isReady()==false)return false;a.stop();if(!a.isLeftClick())return false;this.ondrag=false;document.observe("mousemove",this.mmh);document.observe("mouseup",this.muh);
this.cX=a.pointerX();this.cY=a.pointerY();this.newX=this.cX;this.newY=this.cY;this.beforeStart();this.moveTimer=setInterval(function(){this.moveListener()}.bind(this),10)},mouseMoveHandle:function(a){a.stop();if(this.el==null)return false;this.ondrag=true;this.newX=a.pointerX();this.newY=a.pointerY()},moveListener:function(){if(!this.ondrag)return false;this.distanceX=this.newX-this.cX;this.distanceY=this.newY-this.cY;this.onDragging()},mouseUpHandle:function(){if(this.ondrag)this.ondrag=false;if(!this.el)return false;
document.stopObserving("mousemove",this.mmh);document.stopObserving("mouseup",this.muh);this.beforeFinish();if(this.moveTimer){clearInterval(this.moveTimer);this.moveTimer=null}},onInit:function(){},isReady:function(){return true},beforeStart:function(){},onDragging:function(){},beforeFinish:function(){}});
pie.drag.Simple=Class.create(pie.drag.Base,{onInit:function(){},beforeStart:function(){this.ileft=parseInt(this.el.style.left||0);this.itop=parseInt(this.el.style.top||0)},onDragging:function(){this.el.setStyle({top:this.itop+this.distanceY+"px",left:this.ileft+this.distanceX+"px"})},beforeFinish:function(){}});
pie.drag.Page=Class.create(pie.drag.Base,{onInit:function(){this.beforeDrag=this._config.beforeDrag||function(){}},isReady:function(){if(this.evtel.tagName=="INPUT"||this.evtel.tagName=="TEXTAREA")return false},beforeStart:function(){this.beforeDrag();this.parent=this.el.parentNode;this.scrollX=this.parent.scrollLeft;this.scrollY=this.parent.scrollTop},onDragging:function(){var a=this.scrollX-this.distanceX,b=this.scrollY-this.distanceY;this.parent.scrollLeft=a;this.parent.scrollTop=b;this.xoff=a;
this.yoff=b}});pie.drag.PinNode=Class.create(pie.drag.Base,{onInit:function(){this.node=this.el;this.el=this.node.el;this.node.dragflag=false;this.map_root=this.node.root;this.map=this.node.map;this.effective_distance=200},isReady:function(){return!(this.evtel.tagName=="INPUT"||this.evtel.tagName=="TEXTAREA")},beforeStart:function(){this.map.stop_edit_focus_title();var a=this.__init_dragproxy();this.map.paper.jq.append(a);this.map.ondrag=this.node;this.ileft=parseInt(a.style.left||0);this.itop=parseInt(a.style.top||
0)},__init_dragproxy:function(){this.__build_dragproxy();this.__set_drag_proxy_style();this.dragproxy.update(this.node.nodetitle.jq.html());return this.dragproxy},__build_dragproxy:function(){if(!this.dragproxy)this.dragproxy=$(Builder.node("div",{"class":"node",style:"position:absolute; border:solid 3px; padding:2px 3px;"}))},__set_drag_proxy_style:function(){this.scrolleroffset=this.map.scroller.jq.offset();var a=this.el.cumulativeOffset();this.dragproxy.setStyle({left:a.left-this.scrolleroffset.left+
"px",top:a.top-this.scrolleroffset.top+"px",width:this.node.width-12+"px",height:this.node.height-5+"px",opacity:0.5,zIndex:103,display:"none"})},onDragging:function(){this.node.dragflag=true;this.__update_dragproxy_pos();this.node.nodetitle.jq.addClass("quiet");var a=this.map,b=a.scroller.jq,c=this.newX+b.scrollLeft()-this.scrolleroffset.left,d=this.newY+b.scrollTop()-this.scrolleroffset.top-10;this.__clear_droptarget();a.posRegister.each(function(e){e=e.value;this.looping_node=e[0];var f=e[2]-5,
i=e[4]+5,g=(e[1]+e[3])/2;this.is_drop_on_right=this.__is_drop_on_right(c,g);this.looping_children=this.__get_looping_children();if(this.__can_be_drop(c,g)){e=(c-g).abs()<this.effective_distance&&d>f&&d<=i;if(0==this.looping_children.length){if(e){this.__ready_to_drop_on_as_new_child();throw $break;}this.__ready_to_drop_on_root()}else if(this.looping_node.closed){if(e){this.__ready_to_drop_on_as_one_of_children();throw $break;}this.__ready_to_drop_on_root()}else{var j=false;this.looping_children.each(function(h){this.looping_child=
h;var k=a.posRegister.get(h.id);h=k[2]-5;var l=k[4]+5,m=(h+l)/2;k=((k[1]+k[3])/2-g).abs();if((c-g).abs()<k&&d>h&&d<=l){d<m?this.__ready_to_drop_on_as_older_brother():this.__ready_to_drop_on_as_younger_brother();j=true;throw $break;}}.bind(this));if(j)throw $break;}}}.bind(this))},__update_dragproxy_pos:function(){this.dragproxy.setStyle({left:this.ileft+this.distanceX+"px",top:this.itop+this.distanceY+"px",display:""})},__clear_droptarget:function(){if(this.droptarget!=null){this.droptarget.el.removeClassName("dropon");
this.dropbox.hide();this.dropcanvas.hide()}this.droptarget=null},__is_drop_on_right:function(a,b){var c=this.looping_node;return c==this.map_root?a>=b:c.sub.put_on_right()},__get_looping_children:function(){var a=this.looping_node,b=a.children;return a==this.map_root?this.is_drop_on_right?b.select(function(c){return c.put_on_right()}):b.select(function(c){return!c.put_on_right()}):b},__can_be_drop:function(a,b){var c=this.looping_node;return(this.is_drop_on_right?a>b:a<b)||c==this.map_root},__ready_to_drop_on_as_new_child:function(){this.droptarget=
this.looping_node;this.dropindex=null;this._show_drop_target_tip()},__ready_to_drop_on_as_one_of_children:function(){var a=this.looping_node;this.droptarget=a;this.dropindex=a.children.last().index+1;this._show_drop_target_tip()},__ready_to_drop_on_root:function(){},__ready_to_drop_on_as_older_brother:function(){this.droptarget=this.looping_node;this.dropindex=this.looping_child.index;this._show_drop_target_tip()},__ready_to_drop_on_as_younger_brother:function(){var a=this.looping_node,b=this.looping_children,
c=b.indexOf(this.looping_child);b=b[c+1];this.droptarget=a;this.dropindex=b==null?a.children.length:b.index;this._show_drop_target_tip()},beforeFinish:function(){if(this.droptarget!=null){this.droponNode();this.droptarget.el.removeClassName("dropon");this.droptarget=null;this.dropbox.hide();this.dropcanvas.hide()}if(this.el.dragflag){this.el.dragflag=false;this.map.ondrag={}}this.dragproxy.remove();this.node.nodetitle.jq.removeClass("quiet")},droponNode:function(){var a=this.droptarget;if(!this.__is_target_cannot_be_drop_on()){this.__remove_node_from_node_s_parent_s_children();
this.__add_node_to_target_as_a_child();this.node.pos=this.is_drop_on_right?"right":"left";this.node.__changesub(a==this.map_root?this.node:a.sub);this.__show_children_doms_of_droptarget();this.__do_save_map();this.node.parent.closed&&this.node.parent._expand();this.map.reRank();this.node.select()}},__do_save_map:function(){this.map._save(this.map.opFactory.getMoveInstance(this.node))},__remove_node_from_node_s_parent_s_children:function(){var a=this.___remove_node_from_parent_s_children_array();this.___hide_doms_if_node_has_no_child(a);
this.___hide_node_branch_doms_of_root(a);return a},___remove_node_from_parent_s_children_array:function(){var a=this.node,b=a.parent;b.children=b.children.without(a);b.__tidyChildren();return b},___hide_doms_if_node_has_no_child:function(a){if(0==a.children.length){a.folder.el.hide();a.content.el.hide()}},___hide_node_branch_doms_of_root:function(a){if(a==this.map_root){this.node.branch.el.remove();this.node.branch.el=null;this.node.canvas.el.remove();this.node.canvas.el=null;this.node.container.el.style.left=
""}},__add_node_to_target_as_a_child:function(){var a=this.droptarget,b=this.dropindex,c=a.children;this.node.parent==a&&b>this.node.index&&b--;var d=c.slice(0,b);b=c.slice(b);d.push(this.node);a.children=d.concat(b);this.node.parent=a;a.__tidyChildren()},__show_children_doms_of_droptarget:function(){var a=this.droptarget;a.folder.el.show();a.content.el.show();a.content.el.appendChild(this.node.container.el)},_show_drop_target_tip:function(){this.__build_dropbox();var a=this.map,b=this.droptarget,
c=this.dropindex,d=b==this.map_root;if(!this.__is_target_cannot_be_drop_on()){var e=a.posRegister.get(b.id),f=0,i=0;if(d){f=this.is_drop_on_right?e[3]+40:e[1]-120;i=c==null?e[4]-28+2:c<b.children.length?a.posRegister.get(b.children[c].id)[2]-10:this.is_drop_on_right?a.posRegister.get(b.children.select(function(k){return k.put_on_right()}).last().id)[4]-5:a.posRegister.get(b.children.select(function(k){return!k.put_on_right()}).last().id)[4]-5}else{if(c==null)c=0;f=this.is_drop_on_right?e[3]+10:e[1]-
90;i=b.children.length==0?e[4]-20+2:b.closed?e[4]-20:c<b.children.length?a.posRegister.get(b.children[c].id)[2]-10:a.posRegister.get(b.children.last().id)[4]-5}this.__put_dropbox(f,i);var g=d?(e[1]+e[3])/2:e[3];e=d?(e[2]+e[4])/2:b.canvas.top+b.sub.container.top+this.map_root.posY;c=[i,e].min();var j=d?[e-i,i+20-e].max():[e+b.height-i,i+20-e].max(),h=[g,f+80].min();f=d?[f-g,g-(f+80)].max():10;this.dropcanvas.setStyle({left:h+"px",top:c+"px",width:f+"px",height:j.abs()+"px",zIndex:d?"100":"103",border:"solid 0px",
display:""});this.dropcanvas.setAttribute("width",f);this.dropcanvas.setAttribute("height",j.abs());a.__prepare_canvas_for_ie();this.dropcanvas=$(this.dropcanvas.id);a=this.dropcanvas.getContext("2d");a.fillStyle="#F56F00";a.strokeStyle="#F56F00";a.beginPath();if(b.children.length==0){a.moveTo(0,j.abs()-10);a.lineTo(f,j.abs()-10)}else{j=this.is_drop_on_right?f:0;i=i+10-c;a.moveTo(this.is_drop_on_right?0:f,d?e-c:e+b.height-10-c);a.lineTo(j,i)}a.stroke();b.el.addClassName("dropon")}},__is_target_cannot_be_drop_on:function(){for(var a=
this.droptarget,b=this.map_root;a!=b;){if(this.node==a)return true;a=a.parent}a=this.droptarget;var c=this.dropindex;if(a==this.node.parent)if(a==b){if(this.node.pos==this.is_drop_on_right?"right":"left")return c==this.node.index||c==this.node.index+1}else return c==this.node.index||c==this.node.index+1;return false},__build_dropbox:function(){var a=this.map;if(!this.dropbox){this.dropbox=$(Builder.node("div",{id:"mindmap_dropbox",style:"position:absolute;background-color:#F56F00;-moz-border-radius:4px;-webkit-border-radius:4px;"}));
this.dropcanvas=$(Builder.node("canvas",{id:"mindmap_dropcanvas"}));this.dropcanvas.setStyle({zIndex:"100",position:"absolute",border:"solid 0px"});a.paper.jq.append(this.dropbox);a.paper.jq.append(this.dropcanvas)}},__put_dropbox:function(a,b){this.dropbox.setStyle({left:a+"px",top:b+"px",width:"80px",height:"20px",opacity:0.6,zIndex:103,display:""})}});pie.mindmap=pie.mindmap||{};pie.mindmap.Menu=Class.create();
pie.mindmap.Menu.prototype={initialize:function(a){this.options=a=a||{};this.items=[];this.binder=this.el=null;this.isload=false;this.on=a.on||"contextmenu";this.closeon=a.closeon||"anyclick";this.width=parseInt(a.width)||120;this.border=parseInt(a.border)||1;this.height=2*this.border;this.lh=20;this.observer=$(a.observer||document.body);this.afterload=a.afterload||function(){};this.log=function(){}},bind:function(a,b,c){a=$(a);b=b||"pointer";switch(this.on){case "mouseover":Event.observe(a,"mouseover",
function(d){d.stop();var e=d.fromElement;if(el==d.toElement&&!el.contains(e)){d=this._getPosition(d,a,b);this.load(d.x,d.y,c)}}.bindAsEventListener(this));break;case "contextmenu":default:Event.observe(a,this.on,function(d){d.stop();d=this._getPosition(d,a,b);this.load(d.x,d.y,c)}.bindAsEventListener(this))}switch(this.closeon){case "out":Event.observe(a,"mouseout",function(d){d.stop();d=d.toElement;this.el&&!a.contains(d)&&!this.el.contains(d)&&this.unload()}.bindAsEventListener(this));break;case "anyclick":default:}},
addItem:function(a,b){b=b||{};b.title=(b.title||a).escapeHTML();this.items.push(b);this.height=this.lh*this.items.length+2*this.border},removeItem:function(a){if(typeof a=="number")this.items=this.items.without(this.items[a]);else if(typeof a=="string")this.items.each(function(b){if(b.title==a){this.items=this.items.without(b);throw $break;}}.bind(this));else this.items=this.items.without(a);this.height=this.lh*this.items.length+2*this.border},load:function(a,b,c){setTimeout(function(){var d;this.binder=
c;if(this.el){this.log("load menu cache");d=this.el}else{this.log("create menu element");d=Builder.node("ul",{id:Math.random(),"class":"p_h_m",style:"width:"+this.width+"px; border-width:"+this.border+"px"});this.items.each(function(e){var f=10,i="";if(e.imgurl){i+=" background-image:url("+e.imgurl+"); background-repeat:no-repeat; background-position:"+f+"px center;";f=16+f}var g=Builder.node("li",{"class":e.handler?"has_event":"no_event",style:"padding-left:"+f+"px; width:"+(this.width-f)+"px;"+
i},e.title);e.el=g;var j=e.handler||function(){};Event.observe(g,"mouseover",function(h){h.stop();Element.addClassName(g,"item-mouseover")}.bindAsEventListener(this));Event.observe(g,"mouseout",function(){Element.removeClassName(g,"item-mouseover")}.bindAsEventListener(this));Event.observe(g,"mousedown",function(h){h.stop()});Event.observe(g,"click",function(h){h.stop();Element.removeClassName(g,"item-mouseover");j.bind(this.binder)();this.unload()}.bindAsEventListener(this));Event.observe(g,"contextmenu",
function(h){h.stop()}.bindAsEventListener(this));$(d).insert(g)}.bind(this));document.observe("click",function(){this.unload()}.bindAsEventListener(this));this.el=d}this.items.each(function(e){e.flag&&!e.flag()?$(e.el).hide():$(e.el).show()}.bind(this));this.el.style.left=a+"px";this.el.style.top=b+"px";this.observer.appendChild(this.el);this.afterload();this.isload=true}.bind(this),0)},_getPosition:function(a,b,c){var d,e;e=Element.cumulativeOffset(this.observer.parentNode);d=e.left;e=e.top;switch(c){case "bottom":case "bottom_left":a=
b.cumulativeOffset();b=b.getDimensions();d=a[0]-d;e=a[1]+b.height-e;break;case "bottom_center":a=b.cumulativeOffset();b=b.getDimensions();d=a[0]+(b.width-this.width)/2-d;e=a[1]+b.height-e;break;case "bottom_right":a=b.cumulativeOffset();b=b.getDimensions();d=a[0]+b.width-this.width-2*this.border-d;e=a[1]+b.height-e;break;case "":case "pointer":default:d=Event.pointerX(a);e=Event.pointerY(a);break}this.log("x:"+d+",y:"+e);return{x:d,y:e}},unload:function(){if(this.isload){this.el.remove();this.isload=
false}}};pie.mindmap.NodeTitleEditor=Class.create({initialize:function(a){this.map=a;this._build_title_resizer();this._build_title_input_div()},_build_title_resizer:function(){this.title_resizer={jq:jQuery("<div></div>").css("position","absolute").css("top",-777).css("left",-777).css("background-color","#ccc")}},_build_title_input_div:function(){var a=jQuery("<textarea class='title-inputer'></textarea>");this.title_inputer={jq:a,el:$(a[0])};a=jQuery("<div class='title-input-div'></div>").append(a).hide();
this.title_input_div={jq:a,el:$(a[0])};pie.make_selectable(this.title_inputer.el);Event.observe(this.title_inputer.el,"keydown",function(b){switch(b.keyCode){case Event.KEY_RETURN:if(!b.shiftKey){this.stop_edit();Event.stop(b);return}break}}.bind(this))},do_edit:function(a){this.node=a;this.map.paper.jq.append(this.title_resizer.jq).append(this.title_input_div.jq);this._init_edit();this._position_input_div()},_position_input_div:function(){var a=this.node,b=a.jq.offset(),c=this.map.paper.jq.offset(),
d=b.top-c.top-1;this.title_input_div.jq.css("left",b.left-c.left-1).css("top",d).show();this.title_inputer.jq.select().focus();a.jq.hide()},_init_edit:function(){var a=this.node;a.is_being_edit=true;a._oldtitle=a.title;this.title_resizer.jq.removeClass("root").removeClass("node").addClass(a.is_root()?"root":"node");this.title_inputer.jq.removeClass("iroot").removeClass("inode").addClass(a.is_root()?"iroot":"inode").val(a.title);this._start_timer();this._rebind_change_title_handler();this._init_resizer()},
_start_timer:function(){var a=this.node;if(!this.resizer_timer)this.resizer_timer=setInterval(function(){this.__update_resizer(a)}.bind(this),10)},__update_resizer:function(a){var b=this.title_resizer.jq,c=b.html();a=a.simple_format(this.value());if(a!=c){b.html(a);this.__reset_inputer_size(b.width(),b.height())}},_init_resizer:function(){var a=this.node;this.title_resizer.jq.html(a.simple_format(this.value()));var b=a.jq.width(),c=a.jq.height();if(a.is_root()){b+=10;c+=10}div_width=b+2;ipt_width=
b+100;ipt_height=div_height=c;this.__set_dom_size(div_width,div_height,ipt_width,ipt_height)},__reset_inputer_size:function(a,b){var c=this.title_input_div.jq.width(),d=this.title_input_div.jq.height(),e=this.title_inputer.jq.width(),f=this.title_inputer.jq.height();if(a>c-2){c=a+2;e=a+100}if(b>d)f=d=b;this.__set_dom_size(c,d,e,f)},__set_dom_size:function(a,b,c,d){this.title_input_div.jq.css("width",a).css("height",b);this.title_inputer.jq.css("width",c).css("height",d)},_rebind_change_title_handler:function(){var a=
this.node;Event.stopObserving(this.title_inputer.el,"blur",this.cgt);pie.log("rebind");this.cgt=function(){this.__change_title(a)}.bind(this);Event.observe(this.title_inputer.el,"blur",this.cgt)},__change_title:function(a){if(a.is_being_edit){a.is_being_edit=false;this.title_input_div.jq.hide();if(this.resizer_timer){clearInterval(this.resizer_timer);this.resizer_timer=null}a.set_title_and_save(this.value());this.title_inputer.blur();a.jq.focus()}},stop_edit:function(){this.title_inputer.el.blur()},
value:function(){return this.title_inputer.jq.val()}});pie.mindmap.NodeNoteEditor=Class.create({initialize:function(a){this.map=a;this.sidebar_jq=jQuery(".mindmap-note-sidebar");this.blank_text_jq=this.sidebar_jq.find(".blank-text");this.text_jq=this.sidebar_jq.find(".text");this.ops_jq=this.sidebar_jq.find(".ops");jQuery(document).undelegate(".mindmap_node_note_editor");var b=this;jQuery(document).delegate(".mindmap-note-sidebar .ops a.edit","click.mindmap_node_note_editor",function(){b.map.edit_focus_note()});jQuery(document).delegate(".page-mindmap-note-editor .cancel",
"click.mindmap_node_note_editor",function(){b.close()});jQuery(document).delegate(".page-mindmap-note-editor .accept","click.mindmap_node_note_editor",function(){var c=b.node,d=jQuery(".page-mindmap-note-editor").find("textarea").val();c.set_note_and_save(d);b.close()})},show_note:function(a){var b=a.escaped_note();if(a.is_note_blank()){this.text_jq.html("").hide();this.blank_text_jq.show()}else{this.text_jq.html(b).show();this.blank_text_jq.hide()}},do_edit_note:function(a){this.node=a;this.node.select();
this._show_box();jQuery(".page-mindmap-note-editor").find("textarea").val(this.node.note)},_show_box:function(){var a=jQuery(window).height(),b=jQuery(window).width(),c=jQuery(".page-mindmap-note-editor");c.show().css("left",(b-c.outerWidth())/2).css("top",(a-c.outerHeight())/2);a=jQuery('<div class="page-overlay"></div>').css("opacity",0.4).css("height",a).css("width",b);jQuery("body").append(a)},close:function(){jQuery(".page-mindmap-note-editor").hide();jQuery(".page-overlay").remove()}});pie.mindmap.NodeImageEditor=Class.create({initialize:function(a){this.map=a;this.upload_enlabed=false;jQuery(document).undelegate(".mindmap_node_image_editor");jQuery(document).delegate(".page-mindmap-image-editor .image-list li .ic","click.mindmap_node_image_editor",function(){jQuery(".page-mindmap-image-editor .image-upload .image-list li").removeClass("selected");jQuery(this).closest("li").addClass("selected")});jQuery(document).delegate(".page-mindmap-image-editor a.delete","click.mindmap_node_image_editor",
function(){var c=jQuery(this),d=c.closest("li"),e=d.attr("data-id");c.confirm_dialog("\u786e\u5b9a\u8981\u5220\u9664\u5417\uff1f",function(){jQuery.ajax({url:"/image_attachments/"+e,type:"delete",success:function(){d.fadeOut(200,function(){d.remove()})}})})});var b=this;jQuery(document).delegate(".page-mindmap-image-editor .ops a.cancel","click.mindmap_node_image_editor",function(){b.close()});jQuery(document).delegate(".page-mindmap-image-editor .ops a.accept","click.mindmap_node_image_editor",function(){var c=
b.node,d=jQuery(".page-mindmap-image-editor .image-list li.selected");if(d.length==0){var e=jQuery(".page-mindmap-image-editor span.info");e.html("\u8bf7\u5148\u9009\u62e9\u56fe\u7247").css("padding-left",20).fadeOut(2E3,function(){e.html("").fadeIn(1)})}else{var f=jQuery(".page-mindmap-image-editor .image-size :checked").val(),i=d.attr("data-id"),g,j;if(f=="full"){g=d.attr("data-url-full");j=d.attr("data-width-full");d=d.attr("data-height-full")}else{g=d.attr("data-url-thumb");j=d.attr("data-width-thumb");
d=d.attr("data-height-thumb")}c.set_image_and_save({attach_id:i,url:g,width:j,height:d,size:f},f);b.close()}})},do_edit_image:function(a){this.node=a;this.node.select();this._show_selector_box();this.upload_enabled||this._enable_upload_btn()},do_remove_image:function(a){a.remove_image_and_save()},close:function(){jQuery(".page-mindmap-image-editor").hide();jQuery(".page-overlay").remove()},_show_selector_box:function(){var a=jQuery(window).height(),b=jQuery(window).width(),c=jQuery(".page-mindmap-image-editor");
c.show().css("left",(b-c.outerWidth())/2).css("top",(a-c.outerHeight())/2);a=jQuery('<div class="page-overlay"></div>').css("opacity",0.4).css("height",a).css("width",b);jQuery("body").append(a)},_enable_upload_btn:function(){this.upload_enabled=true;var a={};a[PIE_SESSION_KEY]=PIE_SESSION_VALUE;jQuery(".page-mindmap-image-editor #page-upload-mindmap-img").uploadify({uploader:"/uploadify/uploadify.swf",script:"/image_attachments",cancelImg:"/uploadify/cancel.png",buttonImg:"/uploadify/upload_mindmap_image.png",
width:66,height:21,wmode:"transparent",auto:true,multi:false,fileDataName:"file",fileDesc:"\u56fe\u7247\u6587\u4ef6 png,gif,jpg",fileExt:"*.png;*.gif;*.jpg;*.jpeg;",sizeLimit:4194304,scriptData:a,queueID:"page-mindmap-upload-queue",onComplete:function(b,c,d,e){b=jQuery(e).find(".image-list li");jQuery(".page-mindmap-image-editor .image-list").prepend(b).scrollTop(0);b.hide().fadeIn()},onError:function(b,c,d,e){setTimeout(function(){pie.log(b,c,d,e);jQuery(".uploadifyError .percentage").html(" - \u4e0a\u4f20\u51fa\u9519")},
1)}})}});pie.mindmap.NodeColorEditor=Class.create({initialize:function(a){this.map=a;this.current=jQuery(".page-mindmap-color-editor .current");var b=this;jQuery(document).undelegate(".mindmap_node_color_editor");jQuery(document).delegate(".page-mindmap-color-editor .colors .color","click.mindmap_node_color_editor",function(){jQuery(".page-mindmap-color-editor .colors .color").removeClass("selected");var c=jQuery(this);c.addClass("selected");var d=c.attr("data-bg-color");c=c.attr("data-text-color");b.current.css("background-color",
d).css("color",c);b.bgcolor=d;b.textcolor=c});jQuery(document).delegate(".page-mindmap-color-editor .cancel","click.mindmap_node_color_editor",function(){b.close()});jQuery(document).delegate(".page-mindmap-color-editor .accept","click.mindmap_node_color_editor",function(){if(b.bgcolor!=null){var c=b.node,d=b.map;if(b.bgcolor!=c.bgcolor){c.set_bgcolor(b.bgcolor,b.textcolor);c=d.opFactory.getNodeColorInstance(c);d._save(c)}}b.close()})},do_edit_font:function(a){this.node=a;pie.log(a);this.node.select();
this.bgcolor=this.node.get_bgcolor();this.textcolor=this.node.get_textcolor();this.current.css("background","none").css("background",this.bgcolor).css("color","#333333").css("color",this.textcolor);this._show_selector_box()},_show_selector_box:function(){var a=jQuery(window).height(),b=jQuery(window).width(),c=jQuery(".page-mindmap-color-editor");c.show().css("left",(b-c.outerWidth())/2).css("top",(a-c.outerHeight())/2);a=jQuery('<div class="page-overlay"></div>').css("opacity",0.4).css("height",
a).css("width",b);jQuery("body").append(a)},close:function(){jQuery(".page-mindmap-color-editor").hide();jQuery(".page-overlay").remove()}});pie.mindmap.OperationRecordFactory=Class.create({initialize:function(a){a=a||{};this.map=a.map;this.log=function(){}},getInsertInstance:function(a){return{op:"do_insert",params:{parent_id:a.parent.id,index:a.index,new_node_id:a.id,pos:a.sub.pos}}},getDeleteInstance:function(a){return{op:"do_delete",params:{node_id:a.id}}},getTitleInstance:function(a){return{op:"do_title",params:{node_id:a.id,title:a.title}}},getToggleInstance:function(a){return{op:"do_toggle",params:{node_id:a.id,closed:a.closed}}},
getImageInstance:function(a){return{op:"do_image",params:{node_id:a.id,img_attach_id:a.image.attach_id,img_size:a.image.size}}},getNodeColorInstance:function(a){return{op:"do_nodecolor",params:{node_id:a.id,bgcolor:a.bgcolor,textcolor:a.textcolor}}},getRemoveImageInstance:function(a){return{op:"do_rm_image",params:{node_id:a.id}}},getNoteInstance:function(a){return{op:"do_note",params:{node_id:a.id,note:a.note}}},getMoveInstance:function(a){return{op:"do_move",params:{parent_id:a.parent.id,node_id:a.id,
index:a.index,pos:a.pos}}}});pie.mindmap=pie.mindmap||{};
pie.mindmap.Node=Class.create({initialize:function(a,b){a=a||{};Object.extend(this,a);if(this.revision!=null){this.root=this;this.map=b;this.revision=this.revision||0;this.map.revision={local:this.revision,remote:this.revision}}else{this.parent=b;this.root=b.root;this.map=this.root.map;this.sub=this.parent.is_root()?this:this.parent.sub}this.canvas={};this.branch={};this.top=this.left=0;var c=[];this.children.each(function(e,f){var i=new pie.mindmap.Node(e,this);if(f>0){i.prev=c[f-1];c[f-1].next=
i}i.index=f;c.push(i)}.bind(this));this.children=c;this.dirty=true;try{this.map.nodes.set(this.id,this)}catch(d){alert(d)}this._build_container_dom()},simple_format:function(a){return a.escapeHTML().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;").replace(/>$/,">&nbsp;")},set_title:function(a){a=a==""?" ":a;this.nodetitle.jq.html(this.simple_format(a));this.title=a.replace(/\r\n/g,"\n")},formated_title:function(){return this.simple_format(this.title)},escaped_note:function(){return jQuery.string(this.note).escapeHTML().str.gsub("\n",
"<br/>")},cache_dimensions:function(){if(this.width==null){Object.extend(this,this.el.getDimensions());this.children.each(function(a){a.cache_dimensions()}.bind(this))}},_bindCommonEvents:function(){pie.make_unselectable(this.el);this.el.observe("mouseover",function(){this.el.addClassName("over")}.bind(this)).observe("mouseout",function(){this.el.removeClassName("over")}.bind(this));var a=this.folder.el;a.observe("mouseover",function(){a.addClassName("over")}.bind(this)).observe("mouseout",function(){a.removeClassName("over")}.bind(this)).observe("click",
this.toggle.bind(this));this.el.observe("click",function(b){Event.isLeftClick(b)&&this.is_selected()&&this.map.edit_focus_title();this.select()}.bind(this)).observe("contextmenu",function(){this.select()}.bind(this));pie.isIE()&&this.map.editmode&&this.el.observe("dblclick",function(){this.map.edit_focus_title()}.bind(this));this.map.editmode&&this!=this.root&&new pie.drag.PinNode(this)},_bindShowEvents:function(){this.is_note_blank()||jQuery(this.el).tipsy({html:true,gravity:jQuery.fn.tipsy.autoS,
title:function(){return this.escaped_note()}.bind(this)})},_bindEditEvents:function(){this.map.editmode&&this.map.nodeMenu&&this.map.nodeMenu.bind(this.el,"bottom",this)},select:function(a){var b=this.map;if(this.is_being_edit)return false;if(b.focus){b.stop_edit_focus_title();b.focus.el.removeClassName("selected")}b.focus=this;this.el.addClassName("selected");a||b.__scrollto(this);if(b.editmode){b.nodeMenu.unload();b._node_note_editor.show_note(this)}return this},getPrevCousin:function(){var a=this,
b=0;do{for(var c=a;c=c.prev;)if(c.sub.pos==a.sub.pos)break;if(c){for(;b>0;){b--;if(c.children.length>0&&!c.closed)c=c.children.last()}return c}b++}while(a=a.parent);return this},getNextCousin:function(){var a=this,b=0;do{for(var c=a;c=c.next;)if(c.sub.pos==a.sub.pos)break;if(c){for(;b>0;){b--;if(c.children.length>0&&!c.closed)c=c.children.first()}return c}b++}while(a=a.parent);return this},__tidyChildren:function(){this.children.each(function(a,b){a.index=b;a.prev=b>0?this.children[b-1]:null;a.next=
b<this.children.length-1?this.children[b+1]:null;a.container.top=0}.bind(this))},__changesub:function(a){this.sub.dirty=true;this.sub=a;this.children.each(function(b){b.__changesub(a)}.bind(this));this.sub.dirty=true},hilight:function(a){this.nodebody.jq.css("background-color",a)},do_dirty:function(){if(!this.is_root())this.sub.dirty=true},is_root:function(){return this==this.root},put_on_right:function(){return this.pos=="right"||this.pos==null},is_selected:function(){return this.el.hasClassName("selected")},
is_note_blank:function(){return this.note==""||this.note=="<br>"||this.note=="<br/>"||this.note=="<br />"},get_bgcolor:function(){return this.bgcolor},get_textcolor:function(){return this.textcolor},set_bgcolor:function(a,b){this.bgcolor=a;this.textcolor=b;jQuery(this.el).css("background-color",a);this.nodetitle.jq.css("color",b)},re_rank:function(){Object.extend(this,this.el.getDimensions());this.do_dirty();this.map.reRank()}});
pie.mindmap_node_build_dom_module={_build_container_dom:function(){try{if(this.el==null){this.__build_nodeimage();this.__build_noteicon();this.__build_nodetitle();this.__build_nodebody();this.__build_node();this.folder={id:"f_"+this.id,el:$(Builder.node("div",{"class":this.closed?"foldhandler plus":"foldhandler minus",style:"position:absolute;"+(this.children.length==0?"display:none;":"")}))};this.content={id:"children_"+this.id,top:0,el:$(Builder.node("div",{"class":"mindmap-children",style:"position:absolute"}))};
this.children.each(function(b){this.content.el.insert(b.container.el)}.bind(this));this.container={id:"c_"+this.id,top:0,el:$(Builder.node("div",{"class":"mindmap-container",style:"position:absolute"},this.maxid!=null?[this.el,this.content.el]:[this.el,this.folder.el,this.content.el]))};this._bindCommonEvents();this.map.editmode?this._bindEditEvents():this._bindShowEvents()}}catch(a){alert(a)}return this.container.el},__build_nodeimage:function(){if(this.image)this.image.jq=jQuery("<div class='node-image'></div>").css("background-image",
"url('"+this.image.url+"')").css("height",this.image.height).css("width",this.image.width)},__build_noteicon:function(){this.noteicon={};if(!this.is_note_blank())this.noteicon.jq=jQuery("<div class='note-icon'></div>")},__build_nodetitle:function(){this.nodetitle={jq:jQuery("<div class='nodetitle'></div>").html(this.formated_title())}},__build_nodebody:function(){this.nodebody={jq:jQuery("<div class='nodebody'></div>").append(this.nodetitle.jq).append(this.noteicon.jq)}},__build_node:function(){var a=
jQuery("<div></div>").attr("id",this.id).addClass(this.is_root()?"root":"node").css("background-color",this.bgcolor).css("color",this.textcolor);this.image&&a.append(this.image.jq);a.append(this.nodebody.jq);this.jq=a;this.el=$(a[0])}};pie.mindmap.Node.addMethods(pie.mindmap_node_build_dom_module);pie.mindmap_canvas_draw_module={connect:{},_connectWithDiv:function(){},_drawOnCanvas:function(a){a.canvas.el=$(a.canvas.id);var b=a.canvas.el.getContext("2d");b.strokeStyle=this.lineColor;this._connectWithCanvas_recursion(a,b)},_connectWithCanvas_recursion:function(a,b){var c=this.__getNodePosition(a);b.beginPath();b.moveTo(c.left,c.bottom);b.lineTo(c.right,c.bottom);b.stroke();a.closed||a.children.each(function(d){this._connectWithCanvas_recursion(d,b);b.beginPath();b.moveTo(c.right,c.bottom);b.bezierCurveTo(c.right,
c.bottom,c.right,d.canvas.bottom,d.canvas.left,d.canvas.bottom);b.stroke()}.bind(this))},__getNodePosition:function(a){var b=a.top.round(),c=b+a.height,d,e;d=a.sub.put_on_right()?a.left:a.right;e=d+a.width+this.foldhandler_width/2;if(a.sub!=a){var f=a.parent.content,i=a.container.top+a.parent.canvas.top-(a.parent.top-f.top).round();b+=i;c+=i;f=a.sub.put_on_right()?f.left+a.parent.canvas.left:f.right+a.container.width-a.parent.canvas.left;d+=f;e+=f}if(!a.sub.put_on_right()){d=a.container.width-d;e=
a.container.width-e}a.canvas.top=b;a.canvas.bottom=c;a.canvas.left=d;a.canvas.right=e;return{top:b,right:e,bottom:c,left:d}},_drawOnBranch:function(a){if(!a.free){a.branch.el=$(a.branch.id);var b=a.branch.el.getContext("2d");b.fillStyle=this.lineColor;b.strokeStyle=this.lineColor;this._connect_root_with_canvas(a,b)}},_connect_root_with_canvas:function(a,b){try{var c=pie.mindmap,d=a.sub.put_on_right(),e=a.branch.type==0;(new (d?e?c.RootBranchCanvasRUP:c.RootBranchCanvasRDOWN:e?c.RootBranchCanvasLUP:
c.RootBranchCanvasLDOWN)(a,b)).draw()}catch(f){alert(f)}}};
pie.mindmap.RootBranchCanvasBase=Class.create({initialize:function(a,b){this.map=a.map;this.branch=a.branch;this.ctx=b;this.lw=5;this.p2=Math.PI*2;this.rr=2;this.canvas_overflow=this.map.canvas_overflow;this.qcoff=a.sub.put_on_right()?this.branch.width/3:-this.branch.width/3},draw:function(){this._count_point();var a=this.ctx;a.beginPath();this._draw_connect_line(a);a.stroke();a.fill();a.beginPath();this._draw_arc(a);a.fill()},_draw_connect_line:function(a){a.moveTo(this.x1,this.y1);a.quadraticCurveTo(this.xn-
this.qcoff,this.yn,this.xn,this.yn);a.quadraticCurveTo(this.xn-this.qcoff,this.yn,this.x2,this.y1)},_draw_arc:function(a){a.arc(this.xn,this.yn,this.rr,0,this.p2,true)}});pie.mindmap.RootBranchCanvasRUP=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=0;this.x2=this.lw;this.y1=this.branch.height+this.canvas_overflow;this.xn=this.branch.width-this.rr;this.yn=this.canvas_overflow}});
pie.mindmap.RootBranchCanvasRDOWN=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=0;this.x2=this.lw;this.y1=this.canvas_overflow;this.xn=this.branch.width-this.rr;this.yn=this.branch.height+this.canvas_overflow}});pie.mindmap.RootBranchCanvasLUP=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=this.branch.width;this.x2=this.branch.width-this.lw;this.y1=this.branch.height+this.canvas_overflow;this.xn=this.rr;this.yn=this.canvas_overflow}});
pie.mindmap.RootBranchCanvasLDOWN=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=this.branch.width;this.x2=this.branch.width-this.lw;this.y1=this.canvas_overflow;this.xn=this.rr;this.yn=this.branch.height+this.canvas_overflow}});pie.mindmap_menu_module={_createMenu:function(){try{this.nodeMenu=new pie.mindmap.Menu({observer:$(this.paper.jq[0]),afterload:function(){this.__scrollto(this.nodeMenu)}.bind(this)});this.nodeMenu.addItem("\u65b0\u589e\u3000\u3000 [Ins]",{handler:function(){this.focus.createNewChild()}.bind(this)});this.nodeMenu.addItem("\u5220\u9664\u3000\u3000 [Del]",{handler:function(){this.focus.remove()}.bind(this),flag:function(){return this.focus!=this.root}.bind(this)});this.nodeMenu.addItem("\u7f16\u8f91\u6807\u9898 [\u7a7a\u683c]",
{handler:function(){this.edit_focus_title()}.bind(this)});this.nodeMenu.addItem("\u8282\u70b9\u56fe\u7247 [I]",{handler:this.edit_focus_image.bind(this)});this.nodeMenu.addItem("\u79fb\u9664\u56fe\u7247",{handler:function(){this._node_image_editor.do_remove_image(this.focus)}.bind(this),flag:function(){return this.focus.image}.bind(this)});this.nodeMenu.addItem("\u8282\u70b9\u989c\u8272",{handler:this.edit_focus_color.bind(this)});this.nodeMenu.addItem("\u7f16\u8f91\u5907\u6ce8",{handler:this.edit_focus_note.bind(this)})}catch(a){alert(a)}}};pie.mindmap_save_module={_save:function(a){if(this.editmode)if(this.id!="demo"){this.ajax_save_opers=this.ajax_save_opers||[];this.ajax_save_opers.push(a);this.on_ajax_save!=true&&this.__do_ajax_save()}},__do_ajax_save:function(){var a=this,b=a.ajax_save_opers,c=b.length;b="map="+a.id+"&revision="+encodeURIComponent(Object.toJSON(a.revision))+"&operations="+encodeURIComponent(Object.toJSON(b));a.ajax_save_opers=[];var d;jQuery.ajax({url:"/v6/save",data:b,type:"PUT",beforeSend:function(){d=(new pie.mindmap.InfoLabel(a)).notice("\u6b63\u5728\u81ea\u52a8\u4fdd\u5b58...");
a.on_ajax_save=true;a.toolbar.undo_jq.addClass("lock");a.toolbar.redo_jq.addClass("lock")},success:function(e){d.close();a.revision.remote=e.revision;a.toolbar.undo_jq.removeClass("lock");a.toolbar.redo_jq.addClass("lock")},error:function(e){e=e.responseText.evalJSON().code;pie.log(e);switch(e){case "1":a.__on_node_not_exist();break;case "2":a.__on_mindmap_not_save();break;case "3":a.__on_revision_not_valid();break;case "4":a.__on_access_not_valid();break;default:a.__on_other_error()}},complete:function(){pie.log(a.revision);
a.on_ajax_save=false;a.ajax_save_opers.length>0&&a.__do_ajax_save()}});a.revision.local+=c;pie.log(a.revision)},__on_node_not_exist:function(){(new pie.mindmap.InfoLabel(this)).error("\u8282\u70b9\u4e0d\u5b58\u5728\u6216\u5df2\u5220\u9664\u3002").pulsate();this.lock_mindmap();var a=Builder.node("div",{},[Builder.node("h3",{"class":"f_box"},"\u9519\u8bef#1 \u8bd5\u56fe\u5bf9\u4e00\u4e2a\u4e0d\u5b58\u5728\u7684\u8282\u70b9\u8fdb\u884c\u64cd\u4f5c"),Builder.node("div",{"class":"mindmap_save_error"},
[Builder.node("div",{},"\u5f53\u524d\u6b63\u5728\u88ab\u64cd\u4f5c\u7684\u8282\u70b9\u5728\u670d\u52a1\u5668\u6570\u636e\u4e2d\u4e0d\u5b58\u5728\uff0c\u6216\u8005\u5df2\u88ab\u5176\u4ed6\u534f\u540c\u7f16\u8f91\u8005\u5220\u9664\u3002"),Builder.node("a",{href:"/mindmaps/"+this.id+"/edit"},"\u8bf7\u70b9\u51fb\u8fd9\u91cc\u91cd\u65b0\u8f7d\u5165\u5bfc\u56fe\u3002"),Builder.node("div",{},"\u6216\u624b\u52a8\u5237\u65b0\u9875\u9762")])]);jQuery.facebox(a);jQuery("#facebox_overlay").unbind("click")},__on_mindmap_not_save:function(){(new pie.mindmap.InfoLabel(this)).error("\u5bfc\u56fe\u6570\u636e\u4fdd\u5b58\u5931\u8d25").pulsate();
this.lock_mindmap();var a=Builder.node("div",{},[Builder.node("h3",{"class":"f_box"},"\u9519\u8bef#2 \u4e0a\u4e00\u6b65\u64cd\u4f5c\u4fdd\u5b58\u5931\u8d25"),Builder.node("div",{"class":"mindmap_save_error"},[Builder.node("div",{},"\u7531\u4e8e\u7f51\u7edc\u6216\u670d\u52a1\u5668\u539f\u56e0\uff0c\u6216\u8005\u7531\u4e8e\u5bfc\u56fe\u5df2\u7ecf\u88ab\u5176\u4ed6\u534f\u540c\u7f16\u8f91\u8005\u4fee\u6539\uff0c\u4e0a\u4e00\u6b65\u64cd\u4f5c\u4fdd\u5b58\u5931\u8d25\u3002"),Builder.node("a",{href:"/mindmaps/"+
this.id+"/edit"},"\u8bf7\u70b9\u51fb\u8fd9\u91cc\u91cd\u65b0\u8f7d\u5165\u5bfc\u56fe\u3002"),Builder.node("div",{},"\u6216\u624b\u52a8\u5237\u65b0\u9875\u9762")])]);jQuery.facebox(a);jQuery("#facebox_overlay").unbind("click")},__on_revision_not_valid:function(){(new pie.mindmap.InfoLabel(this)).error("\u5bfc\u56fe\u6570\u636e\u4fdd\u5b58\u5931\u8d25").pulsate();this.lock_mindmap();var a=Builder.node("div",{},[Builder.node("h3",{"class":"f_box"},"\u9519\u8bef#3 \u5bfc\u56fe\u5df2\u7ecf\u88ab\u5176\u4ed6\u4eba\u4fee\u6539"),
Builder.node("div",{"class":"mindmap_save_error"},[Builder.node("div",{},"\u7531\u4e8e\u5bfc\u56fe\u5df2\u7ecf\u88ab\u5176\u4ed6\u534f\u540c\u7f16\u8f91\u8005\u4fee\u6539\uff0c\u64cd\u4f5c\u4fdd\u5b58\u5931\u8d25\u3002"),Builder.node("a",{href:"/mindmaps/"+this.id+"/edit"},"\u8bf7\u70b9\u51fb\u8fd9\u91cc\u91cd\u65b0\u8f7d\u5165\u5bfc\u56fe\u3002"),Builder.node("div",{},"\u6216\u624b\u52a8\u5237\u65b0\u9875\u9762")])]);jQuery.facebox(a);jQuery("#facebox_overlay").unbind("click")},__on_access_not_valid:function(){(new pie.mindmap.InfoLabel(this)).error("\u5bfc\u56fe\u6570\u636e\u4fdd\u5b58\u5931\u8d25").pulsate();
this.lock_mindmap();var a=Builder.node("div",{},[Builder.node("h3",{"class":"f_box"},"\u9519\u8bef#4 \u6ca1\u6709\u7f16\u8f91\u6743\u9650"),Builder.node("div",{"class":"mindmap_save_error"},[Builder.node("div",{},"\u4f60\u5bf9\u5f53\u524d\u5bfc\u56fe\u6ca1\u6709\u7f16\u8f91\u6743\u9650\uff0c\u6216\u8005\u534f\u540c\u7f16\u8f91\u6743\u9650\u5df2\u88ab\u53d6\u6d88\u3002"),Builder.node("a",{href:"/mindmaps/"+this.id+"/edit"},"\u8bf7\u70b9\u51fb\u8fd9\u91cc\u91cd\u65b0\u8f7d\u5165\u5bfc\u56fe\u3002"),
Builder.node("div",{},"\u6216\u624b\u52a8\u5237\u65b0\u9875\u9762")])]);jQuery.facebox(a);jQuery("#facebox_overlay").unbind("click")},__on_other_error:function(){(new pie.mindmap.InfoLabel(this)).error("\u7f51\u7edc\u6216\u670d\u52a1\u53d1\u751f\u5f02\u5e38\u3002").pulsate();this.lock_mindmap();var a=Builder.node("div",{},[Builder.node("h3",{"class":"f_box"},"\u7f51\u7edc\u6216\u670d\u52a1\u53d1\u751f\u5f02\u5e38"),Builder.node("div",{"class":"mindmap_save_error"},[Builder.node("div",{},"\u7531\u4e8e\u7f51\u7edc\u6216\u5176\u4ed6\u539f\u56e0\uff0c\u5bfc\u56fe\u4e0a\u4e00\u6b65\u64cd\u4f5c\u5931\u8d25\u3002"),
Builder.node("a",{href:"/mindmaps/"+this.id+"/edit"},"\u8bf7\u70b9\u51fb\u8fd9\u91cc\u91cd\u65b0\u8f7d\u5165\u5bfc\u56fe\u3002"),Builder.node("div",{},"\u6216\u624b\u52a8\u5237\u65b0\u9875\u9762")])]);jQuery.facebox(a);jQuery("#facebox_overlay").unbind("click")},coop_break:function(){(new pie.mindmap.InfoLabel(this)).error("\u7f51\u7edc\u6216\u670d\u52a1\u53d1\u751f\u5f02\u5e38\u3002").pulsate();this.lock_mindmap();var a=Builder.node("div",{},[Builder.node("h3",{"class":"f_box"},"\u534f\u540c\u7f16\u8f91\u5bfc\u81f4\u7684\u7f16\u8f91\u4e2d\u65ad"),
Builder.node("div",{"class":"mindmap_save_error"},[Builder.node("div",{},"\u5176\u4ed6\u4eba\u6b63\u5728\u7f16\u8f91\u5bfc\u56fe\uff0c\u5bfc\u56fe\u5185\u5bb9\u5df2\u88ab\u4fee\u6539\uff0c\u4f60\u7684\u7f16\u8f91\u88ab\u4e2d\u65ad"),Builder.node("a",{href:"/mindmaps/"+this.id+"/edit"},"\u8bf7\u70b9\u51fb\u8fd9\u91cc\u91cd\u65b0\u8f7d\u5165\u5bfc\u56fe\u3002"),Builder.node("div",{},"\u6216\u624b\u52a8\u5237\u65b0\u9875\u9762")])]);jQuery.facebox(a);jQuery("#facebox_overlay").unbind("click")},lock_mindmap:function(){var a=
this.paper.jq,b=jQuery("<div class='lock-white-board'></div>").css("opacity",0.6).css("width",a.width()).css("height",a.height()).css("position","absolute");a.append(b)}};
pie.mindmap.InfoLabel=Class.create({initialize:function(a){this.map=a;this.el=this._build_dom()},_build_dom:function(){var a=Builder.node("div",{"class":"info-label",style:"display:none;"},""),b=this.map.scroller.jq.parent();b.find(".info-label").remove();b.append(a);return a},hold:function(a){setTimeout(function(){$(this.el).fade({duration:0.2})}.bind(this),a*1E3)},pulsate:function(){new Effect.Pulsate(this.el,{pulses:50,duration:60,from:1,to:0.2});return this},close:function(){$(this.el).fade({duration:0.2});
return this},notice:function(a){$(this.el).addClassName("notice").update(a).appear({duration:0.2});return this},error:function(a){$(this.el).addClassName("error").update(a).appear({duration:0.2});return this}});pie.mindmap_cooprate_response_module={show_op_instance:function(a){var b=a.op;a=a.new_rev_remote;var c=b.op;b=b.params;switch(c){case "do_insert":this._show_insert_instance(b);break;case "do_delete":this._show_delete_instance(b);break;case "do_title":this._show_title_instance(b);break;case "do_image":this._show_image_instance(b);break;default:pie.log(c)}this.revision.remote=a;pie.log(this.revision)},_show_insert_instance:function(a){try{var b=a.new_node_id,c=a.index,d=this.nodes.get(a.parent_id);
this.mr_factory.data_insert(true,c,d,b)}catch(e){alert(e)}},_show_delete_instance:function(a){this.mr_factory.data_remove(true,this.nodes.get(a.node_id))},_show_title_instance:function(a){var b=a.title;this.mr_factory.data_title(true,this.nodes.get(a.node_id),b)},_show_image_instance:function(){}};
pie.mindmap.ModifyingResponseFactory=Class.create({initialize:function(a){a=a||{};this.map=a.map},data_insert:function(a,b,c,d){c.closed&&c.toggle(true);b=c._newChild(b,d);this.map.reRank();if(a){new Effect.Highlight(b.el,{startcolor:"#FF6666",duration:3});return null}else{new Effect.Pulsate(b.el,{duration:0.4});return b}},data_remove:function(a,b){if(a){new Effect.Highlight(b.container.el,{startcolor:"#FF6666"});new Effect.Fade(b.container.el,{afterFinish:function(){b._remove();this.map.reRank()}.bind(this)})}else{b._remove();
this.map.reRank()}},data_title:function(a,b,c){b.set_title(c);b.el.show();b.el.removeClassName("selected");Object.extend(b,b.el.getDimensions());if(b.title!=b._oldtitle){b.do_dirty();this.map.reRank();a&&new Effect.Highlight(b.el,{startcolor:"#FF6666"})}},data_image:function(a,b,c){b.image&&b.image.jq&&b.image.jq.remove();b.image=c;b.__build_nodeimage();b.nodebody.jq.before(b.image.jq);b.re_rank();a&&new Effect.Highlight(b.el,{startcolor:"#FF6666"})},data_remove_image:function(a,b){b.image&&b.image.jq&&
b.image.jq.remove();b.image=null;b.re_rank();a&&new Effect.Highlight(b.el,{startcolor:"#FF6666"})},data_note:function(a,b,c){b.noteicon&&b.noteicon.jq&&b.noteicon.jq.remove();b.note=c;b.__build_noteicon();b.noteicon.jq&&b.nodetitle.jq.after(b.noteicon.jq);b.re_rank();a&&new Effect.Highlight(b.el,{startcolor:"#FF6666"})}});pie.mindmap_node_modifying_methods={createNewSibling:function(){var a=this.map;if(!a._pause())if(!this.is_root()){var b=a.mr_factory.data_insert(false,this.index+1,this.parent);b.select();b=a.opFactory.getInsertInstance(b);a._save(b)}},createNewChild:function(){var a=this.map;if(!a._pause()){var b=a.mr_factory.data_insert(false,this.children.length,this);b.select();b=a.opFactory.getInsertInstance(b);a._save(b)}},remove:function(){var a=this.map;if(!a._pause())if(!this.is_root()){a.mr_factory.data_remove(false,
this);if(this.next)this.next.select();else this.prev?this.prev.select():this.parent.select();var b=a.opFactory.getDeleteInstance(this);a._save(b)}},set_title_and_save:function(a){try{var b=this.map;b.mr_factory.data_title(false,this,a);this.select();if(this.title!=this._oldtitle){var c=b.opFactory.getTitleInstance(this);b._save(c)}}catch(d){alert(d)}},set_image_and_save:function(a){try{var b=this.map;b.mr_factory.data_image(false,this,a);this.select();var c=b.opFactory.getImageInstance(this);b._save(c)}catch(d){alert(d)}},
remove_image_and_save:function(){try{var a=this.map;a.mr_factory.data_remove_image(false,this);this.select();var b=a.opFactory.getRemoveImageInstance(this);a._save(b)}catch(c){alert(c)}},set_note_and_save:function(a){var b=this.map;b.mr_factory.data_note(false,this,a);this.select();a=b.opFactory.getNoteInstance(this);b._save(a)}};
pie.mindmap_node_new_child_methods={_newChild:function(a,b){var c=this.__build_child_hash(b);this.__add_to_children(c,a);this.__add_to_html_dom(c);this.is_root()||this.folder.el.show();c.sub.dirty=true;this.map.nodes.set(c.id,c);return c},__build_child_hash:function(a){a={image:null,closed:false,note:"",children:[],title:"NewSubNode",pos:"right",id:a||pie.randstr()};if(this.is_root()){var b=this.children,c=$A(b).select(function(d){return d.sub.pos=="left"}).length;b=b.length-c;pie.log(b,c);if(b>c+
1)a.pos="left"}return new pie.mindmap.Node(a,this)},__add_to_children:function(a,b){var c=this.children.slice(0,b),d=this.children.slice(b);a.prev=c.last();if(a.prev)a.prev.next=a;a.next=d.first();if(a.next)a.next.prev=a;c.push(a);this.children=c.concat(d);this.children.each(function(e,f){e.index=f}.bind(this))},__add_to_html_dom:function(a){var b=a.container.el,c;if(a.prev){c=this.is_root()?a.prev.canvas.el:a.prev.container.el;c.insert({after:b})}else{c=this.content.el;c.insert({bottom:b})}a.cache_dimensions()}};
pie.mindmap_node_remove_child_methods={_remove:function(){try{var a=this.parent;this.container.el.remove();a.children=a.children.without(this);a.__tidyChildren();if(a.is_root()){this.canvas.el.remove();this.branch.el.remove()}else a.children.length==0&&a.folder.el.hide();this.sub.dirty=true;this.map.nodes.unset(this.id)}catch(b){alert(b)}return this}};
pie.mindmap_node_toggle_methods={toggle:function(a){var b=this.map;if(!(!a&&b._pause())){this._toggle();this.sub.dirty=true;b.reRank();if(b.editmode){a=b.opFactory.getToggleInstance(this);b._save(a)}}},_toggle:function(){this.closed?this._expand():this._collapse();this.content.el.toggle()},_expand:function(){this.folder.el.className="foldhandler minus";this.closed=false},_collapse:function(){var a=this.map.focus;if(a)for(;a!=this.root;){if(a.parent==this){this.select();break}a=a.parent}this.folder.el.className=
"foldhandler plus";this.closed=true}};pie.mindmap.Node.addMethods(pie.mindmap_node_modifying_methods).addMethods(pie.mindmap_node_new_child_methods).addMethods(pie.mindmap_node_toggle_methods).addMethods(pie.mindmap_node_remove_child_methods);pie.mindmap=pie.mindmap||{};
pie.mindmap.BasicMapPaper=Class.create({initialize:function(a,b){b=b||{};Object.extend(this,b);this.editmode=b.editmode==true;this._init_paper(a);this._init_scroller();this._init_toolbar();this._init_const();this.nodes=new Hash;this.editmode&&this._createMenu()},_init_paper:function(a){this.paper={jq:jQuery(a)}},_init_scroller:function(){this.scroller={jq:this.paper.jq.parent()}},_init_toolbar:function(){if(this.editmode){var a=jQuery(".mindmap-paper-toolbar");this.toolbar={jq:a,undo_jq:a.find(".mindmap-ops .mindmap-undo"),
redo_jq:a.find(".mindmap-ops .mindmap-redo")}}},_init_const:function(){this.log=pie.log;this.pause_period=500;this.foldhandler_width=11;this.canvas_overflow=6;this.lineColor="#5c5c5c";if(this.editmode){this._node_title_editor=new pie.mindmap.NodeTitleEditor(this);this._node_image_editor=new pie.mindmap.NodeImageEditor(this);this._node_note_editor=new pie.mindmap.NodeNoteEditor(this);this._node_color_editor=new pie.mindmap.NodeColorEditor(this);this.opFactory=new pie.mindmap.OperationRecordFactory({map:this});
this.mr_factory=new pie.mindmap.ModifyingResponseFactory({map:this})}this.connect=this._connectWithCanvas},load:function(){jQuery.ajax({url:this.data_url,type:"GET",dataType:"json",success:function(a){this.root=new pie.mindmap.Node(a,this);this.initial_data({recenter:true})}.bind(this),error:function(){jQuery.facebox("\u601d\u7ef4\u5bfc\u56fe\u6570\u636e\u5f02\u5e38\uff0c\u8f7d\u5165\u5931\u8d25\u3002")}});return this},undo_load:function(){return this._undo_or_redo_load("undo")},redo_load:function(){return this._undo_or_redo_load("redo")},
_undo_or_redo_load:function(a){var b="";if(a=="undo")b="/mindmaps/"+this.id+"/undo";if(a=="redo")b="/mindmaps/"+this.id+"/redo";if(b=="")return this;var c=this;jQuery.ajax({url:b,type:"PUT",dataType:"json",beforeSend:function(){jQuery(".ajax-loading-bar").css("display","block");c.toolbar.undo_jq.addClass("lock");c.toolbar.redo_jq.addClass("lock")},success:function(d){pie.log(d);this.root=new pie.mindmap.Node(d.map,this);this.initial_data({recenter:false});d.can_undo&&this.toolbar.undo_jq.removeClass("lock");
d.can_redo&&this.toolbar.redo_jq.removeClass("lock")}.bind(this),error:function(){jQuery.facebox("\u601d\u7ef4\u5bfc\u56fe\u6570\u636e\u5f02\u5e38\uff0c\u8f7d\u5165\u5931\u8d25\u3002")},complete:function(){jQuery(".ajax-loading-bar").css("display","none")}});return this},initial_data:function(a){var b=this.paper,c=this.root,d=b.jq;this.el=c.container.el;d.html(this.el);c.cache_dimensions();b.xoff=d.width()/2;b.yoff=d.height()/2;a.recenter==true&&this.recenter();this._set_root_position();this.reRank();
new pie.drag.Page(b.jq[0],{beforeDrag:function(){if(this.editmode){this.nodeMenu.unload();this.stop_edit_focus_title()}}.bind(this)});this._bindHotkeyDispatcher();this.root.select()},recenter:function(){try{var a=this.scroller.jq;a.scrollLeft(this.paper.xoff-a.width()/2);a.scrollTop(this.paper.yoff-a.height()/2)}catch(b){alert(b)}},_set_root_position:function(){var a=this.paper,b=this.root;b.posX=(0-b.width)/2+a.xoff;b.posY=(0-b.height)/2+a.yoff;jQuery(b.container.el).css("left",b.posX).css("top",
b.posY);b.container.el.style.top=b.posY+"px"},__prepare_canvas_for_ie:function(){typeof G_vmlCanvasManager!="undefined"&&G_vmlCanvasManager.init_(document)},reRank:function(){var a=new Date;this.root.children.each(function(c){c.dirty&&this.setCoord(c)}.bind(this));this.setRootCoord(this.root);var b=new Date;pie.log("\u6392\u5217.."+(b-a)+"ms");a=new Date;this.root.children.each(function(c){c.dirty&&this.connect(c);this._connectWithCanvas_branch(c)}.bind(this));this.__prepare_canvas_for_ie();this.root.el.style.zIndex=
"101";this.root.children.each(function(c){if(c.dirty){this._drawOnCanvas(c);c.dirty=false}this._drawOnBranch(c)}.bind(this));b=new Date;this.log("\u753b\u7ebf.."+(b-a)+"ms");this.posRegister=this._updatePosRegister(this.root)},setCoord:function(a){var b=this.foldhandler_width,c=0,d=0;a.closed?Element.hide(a.content.el):a.children.each(function(m){c+=this.setCoord(m);m=m.container.width;if(m>d)d=m}.bind(this));var e=a.width,f=a.height,i=a.container,g=a.content,j=a.folder,h=0;h=0;var k,l;if(c==0){h=
f;a.top=0;g.top=0}else if(f>c){k=a.children.first();h=a.children.last().container;l=a.children.last();k=k.top+k.height;h=h.top+l.top+l.height;h=f-(k+h)/2;g.top=h;a.top=0;h=h+c}else if(f<c){k=a.children.first();h=a.children.last().container;l=a.children.last();k=k.top+k.height;h=h.top+l.top+l.height;h=(k+h)/2-f;g.top=0;a.top=h>0?h:0;h=c}else{h=c;a.top=0;g.top=0}g.height=c;g.width=d;if(a.sub.put_on_right()){g.left=e+b;j.left=e;g.el.style.left=g.left+"px";j.el.style.left=j.left+"px";g.el.style.right=
"";j.el.style.right="";a.el.style.right="";i.el.style.right=""}else{g.right=e+b;j.right=e;a.right=0;i.right=0;g.el.style.right=g.right+"px";j.el.style.right=j.right+"px";a.el.style.right=a.right+"px";i.el.style.right=i.right+"px";g.el.style.left="";j.el.style.left=""}j.top=f-b/2+a.top;i.height=h;i.width=e+b+a.content.width;if(b=a.prev){b.container||this.log(b.title+"****");if(a.parent!=this.root){i.top=b.container.top+b.container.height+10;h+=10}else if(a.free){i.el.style.left=a.freeX+"px";i.top=
b.container.top+b.container.height-a.top+10;i.el.style.top=a.freeY-a.top+"px"}}i.el.style.height=i.height+"px";i.el.style.width=i.width+"px";if(a.free!=true)i.el.style.top=i.top+"px";g.el.style.height=g.height+"px";g.el.style.width=g.width+"px";g.el.style.top=g.top+"px";j.el.style.top=j.top+"px";a.el.style.top=a.top+"px";return h},setRootCoord:function(a){pie.make_unselectable(a.el);a.top=a.el.offsetTop;a.left=a.el.offsetLeft;var b=a.left+(a.width+50),c=-10,d=-10;a.children.each(function(j){if(!j.free){var h=
j.container;if(j.put_on_right()){h.left=b;c+=h.height+10}else{h.left=a.left*2+a.width-b-h.width;d+=h.height+10}h.el.style.left=h.left+"px"}}.bind(this));var e=a.height,f=a.top,i=f-(c-e)/2,g=f-(d-e)/2;a.children.each(function(j){var h=j.container;if(!j.free){if(j.put_on_right()){h.top=i;i+=h.height+10}else{h.top=g;g+=h.height+10}h.el.style.top=h.top+"px"}j=j.canvas;j.el&&j.el.clonePosition(h.el,{setWidth:false,setHeight:false})}.bind(this))},_connectWithCanvas:function(a){var b=a.canvas.el;if(!b){Element.setStyle(a.container.el,
{zIndex:"101"});a.canvas.id="canvas_"+a.id;b=Builder.node("canvas",{id:a.canvas.id});$(b).setStyle({zIndex:"100",position:"absolute",border:"solid 0px"});Element.insert(a.container.el,{after:b});b.clonePosition(a.container.el,{setWidth:false,setHeight:false})}a.canvas.width=a.container.width;a.canvas.height=a.container.height+this.canvas_overflow;b.setAttribute("width",a.canvas.width);b.setAttribute("height",a.canvas.height)},_connectWithCanvas_branch:function(a){if(a.free){if(a.branch.el){Element.remove(a.branch.el);
a.branch={}}}else{this.__countBranch(a);var b=a.branch.el;if(!b){a.branch.id="branch_"+a.id;b=Builder.node("canvas",{id:a.branch.id});$(b).setStyle({zIndex:"100",position:"absolute",border:"solid 0px"});a.container.el.insert({after:b})}b.setAttribute("width",a.branch.width);b.setAttribute("height",a.branch.height+this.canvas_overflow*2);b.setStyle({left:a.branch.left+"px",top:a.branch.top-this.canvas_overflow*2+"px"})}},__countBranch:function(a){if(a.sub.put_on_right()){a.branch.left=a.root.left+
a.root.width/2;a.branch.width=a.container.left-a.branch.left}else{a.branch.left=a.container.left+a.container.width;a.branch.width=a.root.left+a.root.width/2-a.branch.left}if(a.container.top+a.top+a.height<a.root.top+a.root.height/2){a.branch.top=(a.container.top+a.top+a.height).round();a.branch.height=a.root.top+a.root.height/2-a.branch.top;a.branch.type=0}else{a.branch.top=a.root.top+a.root.height/2;a.branch.height=(a.container.top+a.top+a.height-a.branch.top).round();a.branch.type=1}a.branch.top+=
this.canvas_overflow},_updatePosRegister:function(a){$A(document.getElementsByName("postemp")).each(Element.remove);var b=new Hash,c=a.left+this.root.posX,d=a.top+this.root.posY;b.set(a.id,[a,c,d,c+a.width,d+a.height]);a.children.each(function(e){this._updatePosRegister_recursion(e,b)}.bind(this));return b},_updatePosRegister_recursion:function(a,b){var c,d,e,f;d=a.canvas.top+a.sub.container.top-a.top+this.root.posY;e=a.width;f=a.container.height;c=a.canvas.left+a.sub.container.left+this.root.posX;
a.sub.put_on_right()||(c-=a.width);b.set(a.id,[a,c,d,c+e,d+f]);a.closed||a.children.each(function(i){this._updatePosRegister_recursion(i,b)}.bind(this))},__setTempBox:function(a,b,c,d){this.posbox=Builder.node("div",{name:"postemp",style:"position:absolute; background-color:#E8641B;border-top:solid 5px #DF0024;border-bottom:solid 5px #DF0024;"});Element.setStyle(this.posbox,{left:a+"px",top:b+"px",width:c+"px",height:d+"px",opacity:0.3,zIndex:103});this.paper.jq.append(this.posbox)},_bindHotkeyDispatcher:function(){document.stopObserving("keydown",
window._hotkeyDispatcher);window._hotkeyDispatcher=this.hotkeyDispatcher.bind(this);document.observe("keydown",window._hotkeyDispatcher)},hotkeyDispatcher:function(a){if(!(!this.focus||this.focus.is_being_edit)){var b=Event.element(a).tagName;if(pie.isIE()){this.log(b);if(b!="DIV")return}else if(b!="HTML"&&b!="BODY")return;b=a.keyCode;if(!this.is_on_note_edit_status){Event.stop(a);switch(b){case Event.KEY_UP:this._up();break;case Event.KEY_DOWN:this._down();break;case Event.KEY_LEFT:this._left();
break;case Event.KEY_RIGHT:this._right();break}if(this.editmode)switch(b){case Event.KEY_RETURN:this.focus.createNewSibling();break;case 45:this.focus.createNewChild();break;case 46:this.focus.remove();break;case 32:this.edit_focus_title();break;case 73:this.edit_focus_image();break}}}},_up:function(){var a=this.focus;if(a!=a.root){a.getPrevCousin().select();this.log("up:"+a.id)}else a.children.each(function(b){if(b.put_on_right()){b.select();throw $break;}}.bind(this))},_down:function(){var a=this.focus;
if(a!=a.root){a.getNextCousin().select();this.log("down:"+a.id)}else a.children.reverse(false).each(function(b){if(b.put_on_right()){b.select();throw $break;}}.bind(this))},_left:function(){var a=this.focus;if(a!=a.root)if(a.sub.put_on_right()){a.parent.select();this.log("left:"+a.id)}else{if(!a.closed)if(a.children.first()){a.children[((0+a.children.length-1)/2).floor()].select();this.log("left:"+a.id)}}else a.children.each(function(b){if(!b.put_on_right()){b.select();throw $break;}}.bind(this))},
_right:function(){var a=this.focus;if(a!=a.root)if(a.sub.put_on_right()){if(!a.closed)if(a.children.first()){a.children[((0+a.children.length-1)/2).floor()].select();this.log("left:"+a.id)}}else{a.parent.select();this.log("left:"+a.id)}else a.children.each(function(b){if(b.put_on_right()){b.select();throw $break;}}.bind(this))},__scrollto:function(a){if(a.el.visible()){var b=this.scroller.jq,c=b.width(),d=b.height(),e=b.offset(),f=jQuery(a.el).offset(),i=0;if(f.left<e.left)i=f.left-e.left;else{var g=
f.left+a.width;c=e.left+c-20;if(g>c)i=g-c}g=0;if(f.top<e.top)g=f.top-e.top;else{a=f.top+a.height;d=e.top+d-20;if(a>d)g=a-d}if(i!=0||g!=0)b.animate({scrollLeft:"+="+i,scrollTop:"+="+g},400)}},_pause:function(a){if(this.pause==true)return true;else{this.pause=true;a=a||this.pause_period;setTimeout(function(){this.pause=false}.bind(this),a);return false}}});
pie.mindmap_focus_methods={edit_focus_image:function(){this._can_edit_focus()&&this._node_image_editor.do_edit_image(this.focus)},edit_focus_note:function(){this._can_edit_focus()&&this._node_note_editor.do_edit_note(this.focus)},edit_focus_color:function(){this._can_edit_focus()&&this._node_color_editor.do_edit_font(this.focus)},edit_focus_title:function(){this._can_edit_focus()&&this._node_title_editor.do_edit(this.focus)},stop_edit_focus_title:function(){this.focus&&this.focus.is_being_edit&&this._node_title_editor.stop_edit()},
_can_edit_focus:function(){return this.editmode&&this.focus}};pie.mindmap.BasicMapPaper.addMethods(pie.mindmap_canvas_draw_module).addMethods(pie.mindmap_menu_module).addMethods(pie.mindmap_save_module).addMethods(pie.mindmap_cooprate_response_module).addMethods(pie.mindmap_focus_methods);
