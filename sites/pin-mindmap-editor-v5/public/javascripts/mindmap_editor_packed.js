pie.drag={};
pie.drag.Base=Class.create({initialize:function(a,b){this.el=$(a);this._config=b;this.onInit();this.mdh=this.mouseDownHandle.bindAsEventListener(this);this.mmh=this.mouseMoveHandle.bindAsEventListener(this);this.muh=this.mouseUpHandle.bindAsEventListener(this);this.el.observe("mousedown",this.mdh)},mouseDownHandle:function(a){this.evtel=a.element();if(this.isReady()==false)return false;a.stop();if(!a.isLeftClick())return false;this.ondrag=false;document.observe("mousemove",this.mmh);document.observe("mouseup",this.muh);
this.cX=a.pointerX();this.cY=a.pointerY();this.newX=this.cX;this.newY=this.cY;this.beforeStart();this.moveTimer=setInterval(function(){this.moveListener()}.bind(this),10)},mouseMoveHandle:function(a){a.stop();if(this.el==null)return false;this.ondrag=true;this.newX=a.pointerX();this.newY=a.pointerY()},moveListener:function(){if(!this.ondrag)return false;this.distanceX=this.newX-this.cX;this.distanceY=this.newY-this.cY;this.onDragging()},mouseUpHandle:function(){if(this.ondrag)this.ondrag=false;if(!this.el)return false;
document.stopObserving("mousemove",this.mmh);document.stopObserving("mouseup",this.muh);this.beforeFinish();if(this.moveTimer){clearInterval(this.moveTimer);this.moveTimer=null}},onInit:function(){},isReady:function(){return true},beforeStart:function(){},onDragging:function(){},beforeFinish:function(){}});
pie.drag.Simple=Class.create(pie.drag.Base,{onInit:function(){},beforeStart:function(){this.ileft=parseInt(this.el.style.left||0);this.itop=parseInt(this.el.style.top||0)},onDragging:function(){this.el.setStyle({top:this.itop+this.distanceY+"px",left:this.ileft+this.distanceX+"px"})},beforeFinish:function(){}});
pie.drag.Page=Class.create(pie.drag.Base,{onInit:function(){this.beforeDrag=this._config.beforeDrag||function(){}},isReady:function(){if(this.evtel.tagName=="INPUT"||this.evtel.tagName=="TEXTAREA")return false},beforeStart:function(){this.beforeDrag();this.parent=this.el.parentNode;this.scrollX=this.parent.scrollLeft;this.scrollY=this.parent.scrollTop},onDragging:function(){var a=this.scrollX-this.distanceX,b=this.scrollY-this.distanceY;this.parent.scrollLeft=a;this.parent.scrollTop=b;this.xoff=a;
this.yoff=b}});pie.drag.PinNode=Class.create(pie.drag.Base,{onInit:function(){this.node=this.el;this.el=this.node.el;this.node.dragflag=false;this.map_root=this.node.root;this.map=this.map_root.map;this.effective_distance=200},isReady:function(){return!(this.evtel.tagName=="INPUT"||this.evtel.tagName=="TEXTAREA")},beforeStart:function(){this.__stop_edit_title_while_drap_start();var a=this.__init_dragproxy();this.map.paper.el.appendChild(a);this.map.ondrag=this.node;this.ileft=parseInt(a.style.left||0);this.itop=
parseInt(a.style.top||0)},__stop_edit_title_while_drap_start:function(){this.map.focus&&this.map.focus.onedit&&this.map.title_textarea.blur()},__init_dragproxy:function(){this.__build_dragproxy();this.__set_drag_proxy_style();this.dragproxy.update(this.node.nodetitle.el.innerHTML);return this.dragproxy},__build_dragproxy:function(){if(!this.dragproxy)this.dragproxy=$(Builder.node("div",{"class":"node",style:"position:absolute; border:solid 3px; padding:2px 3px;"}))},__set_drag_proxy_style:function(){this.scrolleroffset=
this.map.paper.el.up().cumulativeOffset();var a=this.el.cumulativeOffset();this.dragproxy.setStyle({left:a.left-this.scrolleroffset.left+"px",top:a.top-this.scrolleroffset.top+"px",width:this.node.width-12+"px",height:this.node.height-5+"px",opacity:0.5,zIndex:103,display:"none"})},onDragging:function(){this.node.dragflag=true;this.__update_dragproxy_pos();$(this.node.nodetitle.el).addClassName("quiet");var a=this.map,b=a.observer.el,c=this.newX+b.scrollLeft-this.scrolleroffset.left,d=this.newY+b.scrollTop-
this.scrolleroffset.top-10;this.__clear_droptarget();a.posRegister.each(function(e){e=e.value;this.looping_node=e[0];var f=e[2]-5,g=e[4]+5,h=(e[1]+e[3])/2;this.is_drop_on_right=this.__is_drop_on_right(c,h);this.looping_children=this.__get_looping_children();if(this.__can_be_drop(c,h)){e=(c-h).abs()<this.effective_distance&&d>f&&d<=g;if(0==this.looping_children.length){if(e){this.__ready_to_drop_on_as_new_child();throw $break;}this.__ready_to_drop_on_root()}else if(1==this.looping_node.fold){if(e){this.__ready_to_drop_on_as_one_of_children();
throw $break;}this.__ready_to_drop_on_root()}else{var j=false;this.looping_children.each(function(i){this.looping_child=i;var k=a.posRegister.get(i.id);i=k[2]-5;var l=k[4]+5,m=(i+l)/2;k=((k[1]+k[3])/2-h).abs();if((c-h).abs()<k&&d>i&&d<=l){d<m?this.__ready_to_drop_on_as_older_brother():this.__ready_to_drop_on_as_younger_brother();j=true;throw $break;}}.bind(this));if(j)throw $break;}}}.bind(this))},__update_dragproxy_pos:function(){this.dragproxy.setStyle({left:this.ileft+this.distanceX+"px",top:this.itop+
this.distanceY+"px",display:""})},__clear_droptarget:function(){if(this.droptarget!=null){this.droptarget.el.removeClassName("dropon");this.dropbox.hide();this.dropcanvas.hide()}this.droptarget=null},__is_drop_on_right:function(a,b){var c=this.looping_node;return c==this.map_root?a>=b:c.sub.putright},__get_looping_children:function(){var a=this.looping_node,b=a.children;return a==this.map_root?this.is_drop_on_right?b.select(function(c){return c.putright}):b.select(function(c){return!c.putright}):
b},__can_be_drop:function(a,b){var c=this.looping_node;return(this.is_drop_on_right?a>b:a<b)||c==this.map_root},__ready_to_drop_on_as_new_child:function(){this.droptarget=this.looping_node;this.dropindex=null;this._show_drop_target_tip()},__ready_to_drop_on_as_one_of_children:function(){var a=this.looping_node;this.droptarget=a;this.dropindex=a.children.last().index+1;this._show_drop_target_tip()},__ready_to_drop_on_root:function(){},__ready_to_drop_on_as_older_brother:function(){this.droptarget=
this.looping_node;this.dropindex=this.looping_child.index;this._show_drop_target_tip()},__ready_to_drop_on_as_younger_brother:function(){var a=this.looping_node,b=this.looping_children,c=b.indexOf(this.looping_child);b=b[c+1];this.droptarget=a;this.dropindex=b==null?a.children.length:b.index;this._show_drop_target_tip()},beforeFinish:function(){if(this.droptarget!=null){this.droponNode();this.droptarget.el.removeClassName("dropon");this.droptarget=null;this.dropbox.hide();this.dropcanvas.hide()}if(this.el.dragflag){this.el.dragflag=
false;this.map.ondrag={}}this.dragproxy.remove();$(this.node.nodetitle.el).removeClassName("quiet")},droponNode:function(){var a=this.droptarget;if(!this.__is_target_cannot_be_drop_on()){this.__remove_node_from_node_s_parent_s_children();this.__add_node_to_target_as_a_child();this.node.putright=this.is_drop_on_right;this.node.__changesub(a==this.map_root?this.node:a.sub);this.__show_children_doms_of_droptarget();this.__do_save_map();this.node.parent.fold==1&&this.node.parent._expand();this.map.reRank();
this.node.select()}},__do_save_map:function(){this.map._save(this.map.opFactory.getMoveInstance(this.node))},__remove_node_from_node_s_parent_s_children:function(){var a=this.___remove_node_from_parent_s_children_array();this.___hide_doms_if_node_has_no_child(a);this.___hide_node_branch_doms_of_root(a);return a},___remove_node_from_parent_s_children_array:function(){var a=this.node,b=a.parent;b.children=b.children.without(a);b.__tidyChildren();return b},___hide_doms_if_node_has_no_child:function(a){if(0==
a.children.length){a.folder.el.hide();a.content.el.hide()}},___hide_node_branch_doms_of_root:function(a){if(a==this.map_root){this.node.branch.el.remove();this.node.branch.el=null;this.node.canvas.el.remove();this.node.canvas.el=null;this.node.container.el.style.left=""}},__add_node_to_target_as_a_child:function(){var a=this.droptarget,b=this.dropindex,c=a.children;this.node.parent==a&&b>this.node.index&&b--;var d=c.slice(0,b);b=c.slice(b);d.push(this.node);a.children=d.concat(b);this.node.parent=
a;a.__tidyChildren()},__show_children_doms_of_droptarget:function(){var a=this.droptarget;a.folder.el.show();a.content.el.show();a.content.el.appendChild(this.node.container.el)},_show_drop_target_tip:function(){this.__build_dropbox();var a=this.map,b=this.droptarget,c=this.dropindex,d=b==this.map_root;if(!this.__is_target_cannot_be_drop_on()){var e=a.posRegister.get(b.id),f=0,g=0;if(d){f=this.is_drop_on_right?e[3]+40:e[1]-120;g=c==null?e[4]-28+2:c<b.children.length?a.posRegister.get(b.children[c].id)[2]-
10:this.is_drop_on_right?a.posRegister.get(b.children.select(function(k){return k.putright}).last().id)[4]-5:a.posRegister.get(b.children.select(function(k){return!k.putright}).last().id)[4]-5}else{if(c==null)c=0;f=this.is_drop_on_right?e[3]+10:e[1]-90;g=b.children.length==0?e[4]-20+2:b.fold==1?e[4]-20:c<b.children.length?a.posRegister.get(b.children[c].id)[2]-10:a.posRegister.get(b.children.last().id)[4]-5}this.__put_dropbox(f,g);var h=d?(e[1]+e[3])/2:e[3];e=d?(e[2]+e[4])/2:b.canvas.top+b.sub.container.top+
this.map_root.posY;c=[g,e].min();var j=d?[e-g,g+20-e].max():[e+b.height-g,g+20-e].max(),i=[h,f+80].min();f=d?[f-h,h-(f+80)].max():10;this.dropcanvas.setStyle({left:i+"px",top:c+"px",width:f+"px",height:j.abs()+"px",zIndex:d?"100":"103",border:"solid 0px",display:""});this.dropcanvas.setAttribute("width",f);this.dropcanvas.setAttribute("height",j.abs());a.__prepare_canvas_for_ie();this.dropcanvas=$(this.dropcanvas.id);a=this.dropcanvas.getContext("2d");a.fillStyle="#F56F00";a.strokeStyle="#F56F00";
a.beginPath();if(b.children.length==0){a.moveTo(0,j.abs()-10);a.lineTo(f,j.abs()-10)}else{j=this.is_drop_on_right?f:0;g=g+10-c;a.moveTo(this.is_drop_on_right?0:f,d?e-c:e+b.height-10-c);a.lineTo(j,g)}a.stroke();b.el.addClassName("dropon")}},__is_target_cannot_be_drop_on:function(){for(var a=this.droptarget,b=this.map_root;a!=b;){if(this.node==a)return true;a=a.parent}a=this.droptarget;var c=this.dropindex;if(a==this.node.parent)if(a==b){if(this.node.putright==this.is_drop_on_right)return c==this.node.index||
c==this.node.index+1}else return c==this.node.index||c==this.node.index+1;return false},__build_dropbox:function(){var a=this.map;if(!this.dropbox){this.dropbox=$(Builder.node("div",{id:"mindmap_dropbox",style:"position:absolute;background-color:#F56F00;-moz-border-radius:4px;-webkit-border-radius:4px;"}));this.dropcanvas=$(Builder.node("canvas",{id:"mindmap_dropcanvas"}));this.dropcanvas.setStyle({zIndex:"100",position:"absolute",border:"solid 0px"});a.paper.el.appendChild(this.dropbox);a.paper.el.appendChild(this.dropcanvas)}},
__put_dropbox:function(a,b){this.dropbox.setStyle({left:a+"px",top:b+"px",width:"80px",height:"20px",opacity:0.6,zIndex:103,display:""})}});pie.mindmap=pie.mindmap||{};pie.mindmap.Menu=Class.create();
pie.mindmap.Menu.prototype={initialize:function(a){this.options=a=a||{};this.items=[];this.binder=this.el=null;this.isload=false;this.on=a.on||"contextmenu";this.closeon=a.closeon||"anyclick";this.width=parseInt(a.width)||120;this.border=parseInt(a.border)||1;this.height=2*this.border;this.lh=20;this.observer=$(a.observer||document.body);this.afterload=a.afterload||function(){};this.log=function(){}},bind:function(a,b,c){a=$(a);b=b||"pointer";switch(this.on){case "mouseover":Event.observe(a,"mouseover",
function(d){d.stop();var e=d.fromElement;if(el==d.toElement&&!el.contains(e)){d=this._getPosition(d,a,b);this.load(d.x,d.y,c)}}.bindAsEventListener(this));break;case "contextmenu":default:Event.observe(a,this.on,function(d){d.stop();d=this._getPosition(d,a,b);this.load(d.x,d.y,c)}.bindAsEventListener(this))}switch(this.closeon){case "out":Event.observe(a,"mouseout",function(d){d.stop();d=d.toElement;this.el&&!a.contains(d)&&!this.el.contains(d)&&this.unload()}.bindAsEventListener(this));break;case "anyclick":default:}},
addItem:function(a,b){b=b||{};b.title=(b.title||a).escapeHTML();this.items.push(b);this.height=this.lh*this.items.length+2*this.border},removeItem:function(a){if(typeof a=="number")this.items=this.items.without(this.items[a]);else if(typeof a=="string")this.items.each(function(b){if(b.title==a){this.items=this.items.without(b);throw $break;}}.bind(this));else this.items=this.items.without(a);this.height=this.lh*this.items.length+2*this.border},load:function(a,b,c){setTimeout(function(){var d;this.binder=
c;if(this.el){this.log("load menu cache");d=this.el}else{this.log("create menu element");d=Builder.node("ul",{id:Math.random(),"class":"p_h_m",style:"width:"+this.width+"px; border-width:"+this.border+"px"});this.items.each(function(e){var f=10,g="";if(e.imgurl){g+=" background-image:url("+e.imgurl+"); background-repeat:no-repeat; background-position:"+f+"px center;";f=16+f}var h=Builder.node("li",{"class":e.handler?"has_event":"no_event",style:"padding-left:"+f+"px; width:"+(this.width-f)+"px;"+
g},e.title);e.el=h;var j=e.handler||function(){};Event.observe(h,"mouseover",function(i){i.stop();Element.addClassName(h,"item-mouseover")}.bindAsEventListener(this));Event.observe(h,"mouseout",function(){Element.removeClassName(h,"item-mouseover")}.bindAsEventListener(this));Event.observe(h,"mousedown",function(i){i.stop()});Event.observe(h,"click",function(i){i.stop();Element.removeClassName(h,"item-mouseover");j.bind(this.binder)();this.unload()}.bindAsEventListener(this));Event.observe(h,"contextmenu",
function(i){i.stop()}.bindAsEventListener(this));$(d).insert(h)}.bind(this));document.observe("click",function(){this.unload()}.bindAsEventListener(this));this.el=d}this.items.each(function(e){e.flag&&!e.flag()?$(e.el).hide():$(e.el).show()}.bind(this));this.el.style.left=a+"px";this.el.style.top=b+"px";this.observer.appendChild(this.el);this.afterload();this.isload=true}.bind(this),0)},_getPosition:function(a,b,c){var d,e;e=Element.cumulativeOffset(this.observer.parentNode);d=e.left;e=e.top;switch(c){case "bottom":case "bottom_left":a=
b.cumulativeOffset();b=b.getDimensions();d=a[0]-d;e=a[1]+b.height-e;break;case "bottom_center":a=b.cumulativeOffset();b=b.getDimensions();d=a[0]+(b.width-this.width)/2-d;e=a[1]+b.height-e;break;case "bottom_right":a=b.cumulativeOffset();b=b.getDimensions();d=a[0]+b.width-this.width-2*this.border-d;e=a[1]+b.height-e;break;case "":case "pointer":default:d=Event.pointerX(a);e=Event.pointerY(a);break}this.log("x:"+d+",y:"+e);return{x:d,y:e}},unload:function(){if(this.isload){this.el.remove();this.isload=
false}}};pie.mindmap.NodeTitleEditor=Class.create({initialize:function(){this.log=function(){}},doEditTitle:function(a){var b=a.root.map;this.map=b;if(b.focus==a&&b.editmode){a.isOnTitleEditStatus=true;a._oldtitle=a.title;this.log("edit:"+a.id);if(!b.resizer)b.resizer=Builder.node("div",{style:"position:absolute;top:-777px; left:-777px;background-color:#ccc;"});if(!b.editorbox){b.title_textarea=Builder.node("textarea",{style:"overflow:hidden;"});b.editorbox=Builder.node("div",{"class":"editorbox"},b.title_textarea);
Element.makeSelectable(b.title_textarea);Event.observe(b.title_textarea,"keydown",function(d){switch(d.keyCode){case Event.KEY_RETURN:if(!d.shiftKey){b.title_textarea.blur();Event.stop(d);return false}break}}.bind(this))}if(!this.resizeTimer)this.resizeTimer=setInterval(function(){this.__update_resizer(a)}.bind(this),10);var c=a==a.root;b.resizer.className=c?"root":"node";b.title_textarea.className=c?"title_textarea_root":"title_textarea";Event.stopObserving(b.title_textarea,"blur",this.cgt);this.cgt=
function(){this.__changeTitle(a)}.bind(this);Event.observe(b.title_textarea,"blur",this.cgt);b.title_textarea.value=a.title;b.paper.el.appendChild(b.resizer);this.__init_resizer(a);b.paper.el.appendChild(b.editorbox);Position.clone(a.el,b.editorbox,{setWidth:false,setHeight:false});b.editorbox.show();b.title_textarea.select();b.title_textarea.focus();a.el.hide()}else return false},__init_resizer:function(a){var b=this.map;Element.update(b.resizer,a.__format_title(b.title_textarea.value));this.__resetSize(a.width,
a.height,true)},__update_resizer:function(a){var b=this.map;Element.update(b.resizer,a.__format_title(b.title_textarea.value));this.__resetSize(b.resizer.offsetWidth,b.resizer.offsetHeight)},__resetSize:function(a,b,c){var d=this.map,e=this.map.focus==this.map.focus.root,f=parseInt(d.editorbox.style.width),g=parseInt(d.editorbox.style.height),h=parseInt(d.title_textarea.style.width);d=parseInt(d.title_textarea.style.height);if(c)if(e){f=a-6;h=a-12;g=b-6;d=b-10}else{f=a-6;h=a-10;g=b-1;d=b-5}else{if(a>
f)if(e){f=a-6;h=a-12}else{f=a;h=a-4}if(b>g)if(e){g=b-6;d=b-10}else{g=b-1;d=b-5}}this.___setSize(f,g,h,d)},___setSize:function(a,b,c,d){$(this.map.editorbox).setStyle({width:a+"px",height:b+"px"});$(this.map.title_textarea).setStyle({width:c+"px",height:d+"px"})},__changeTitle:function(a){var b=a.root.map;b.editorbox.hide();if(this.resizeTimer){clearInterval(this.resizeTimer);this.resizeTimer=null}Element.update(a.nodetitle.el,a.__format_title(b.title_textarea.value));a.title=pie.isIE()?b.title_textarea.value.replace(/\r\n/g,
"\n"):b.title_textarea.value;if(a.title==""){a.title=" ";a.nodetitle.el.update("&nbsp;")}a.el.show();a.el.removeClassName("node_selected");a.el.removeClassName("root_selected");Object.extend(a,a.el.getDimensions());if(a.title!=a._oldtitle){var c=b.opFactory.getTitleInstance(a);b._save(c);if(a.sub)a.sub.dirty=true;b.reRank()}b.title_textarea.blur();a.el.focus();a.isOnTitleEditStatus=false;a.select()}});
pie.mindmap.NodeFontEditor=Class.create({initialize:function(){this.log=function(){};this.h=[];this.h[0]="FF";this.h[1]="CC";this.h[2]="99";this.h[3]="66";this.h[4]="33";this.h[5]="00"},doEditFont:function(a){this.get_cube();var b=a.fontsize||12,c=a.fontcolor||"#000000";$("fontsize").value=b;$("fontcolor").value=c;$("accept_font").observe("click",function(){var d=$("fontsize").value,e=$("fontcolor").value;a.nodetitle.el.setStyle({fontSize:d+"px",color:e});a.fontsize=d;a.fontcolor=e;Lightview.hide()}.bind(this));
Lightview.show({href:"#fontselector",title:"\u4fee\u6539\u5b57\u4f53",caption:"\u8f93\u5165\u5b57\u4f53\u5927\u5c0f/\u989c\u8272",width:"500px"})},get_cube:function(){if($("colorzone").innerHTML.blank())for(var a=0;a<6;a++){for(var b=document.createElement("ul"),c=0;c<6;c++)for(var d=0;d<6;d++){var e=this.h[a],f=this.h[c],g=this.h[d],h=document.createElement("li"),j=document.createElement("a");j.style.background="#"+e+f+g;h.title="#"+e+f+g;h.appendChild(j);b.appendChild(h)}$(b).observe("click",function(i){i=
i.element().parentNode.title;$("fontcolor").value=i});$("colorzone").appendChild(b)}}});
pie.mindmap.NodeImageEditor=Class.create({initialize:function(){this.log=function(){}},doEditImage:function(a){this.editing_image_node=a;a.select();$("accept_img").disabled=true;if(a.image.url){var b=$(Builder.node("img",{src:a.image.url,height:a.image.height,width:a.image.width,onerror:"return false"}));$("imgpreview").update(b);$("imgwidth").value=a.image.width;$("imgheight").value=a.image.height;$("imgurl").value=a.image.url;$("accept_img").disabled=false}else{$("imgpreview").update();$("imgwidth").value=
"";$("imgheight").value="";$("imgurl").value=""}this._bind_button_event();Lightview.show({href:"#imgselector",title:"\u6dfb\u52a0\u56fe\u7247",caption:"\u8f93\u5165\u56fe\u7247\u7684URL\u5730\u5740"})},_bind_button_event:function(){if(!this.image_event_loaded){$("load_img").observe("click",this._do_load_image.bind(this));$("accept_img").observe("click",this._do_accept_image.bind(this));this.image_event_loaded=true}},_do_load_image:function(){var a=$("imgurl").value,b=Builder.node("img",{src:a});Event.observe(b,
"load",function(){$("imgwidth").value=b.width;$("imgheight").value=b.height;$("accept_img").disabled=false}.bind(this));$("imgpreview").update(b)},_do_accept_image:function(){var a=this.editing_image_node;a.image.el&&a.image.el.remove();a.image={url:$("imgurl").value,width:$("imgwidth").value,height:$("imgheight").value,border:1};a.image.el=$(Builder.node("img",{src:a.image.url,height:a.image.height,width:a.image.width,onerror:"return false"}));a.nodeimg={el:$(Builder.node("div",{"class":"nodeimg"},
a.image.el))};Event.observe(a.image.el,"load",function(){Object.extend(a,a.el.getDimensions());a.sub.dirty=true;a.root.map.reRank()}.bind(this));a.nodebody.el.insert({before:a.nodeimg.el});var b=a.root.map.opFactory.getImageInstance(a);a.root.map._save(b);Lightview.hide()},doRemoveImage:function(a){a.image.el&&a.image.el.remove();a.image={url:null,width:null,height:null,border:1};Object.extend(a,a.el.getDimensions());var b=a.root.map.opFactory.getImageInstance(a);a.root.map._save(b);a.sub.dirty=true;
a.root.map.reRank()}});
pie.mindmap.NoteHandler=Class.create({initialize:function(){this.log=function(){}},onNoteEditBegin:function(a){this.map=a=a.root.map;if(a.editmode&&a.focus){a.isOnNoteEditStatus=true;this.peee&&this.peee.stop();this.peee=new PeriodicalExecuter(this.onNoteChange.bind(this),5);a.focus.notecache=a._noteEditor.nicInstances[0].getContent()}},onNoteEditEnd:function(){var a=this.map;this.onNoteChange();this.peee.stop();a.isOnNoteEditStatus=false;a._noteEditor.el.blur();pie.isIE()||window.focus()},onNoteChange:function(){var a=
this.map;if(a.editmode&&a.focus){var b=a.focus,c=a._noteEditor.nicInstances[0].getContent();if(c==b.notecache)return false;b.notecache=c;if(a.id){b.note=c;var d=a.opFactory.getNoteInstance(b);a._save(d)}if(c!=""&&c!="<br>"){if(!b.noteicon.el){this.log(333);b.noteicon={el:$(Builder.node("div",{"class":"noteicon"}))};b.nodetitle.el.insert({After:b.noteicon.el});b.width+=10;b.sub.dirty=true;b.root.map.reRank()}}else{if(b.note==""||b.note=="<br>")if(b.noteicon.el){Element.remove(b.noteicon.el);b.noteicon=
{}}b.width-=10;b.sub.dirty=true;b.root.map.reRank()}}}});pie.mindmap.OperationRecordFactory=Class.create({initialize:function(a){a=a||{};this.map=a.map;this.log=function(){}},getInsertInstance:function(a){return{op:"do_insert",params:{parent_id:a.parent.id,index:a.index,new_node_id:a.id}}},getDeleteInstance:function(a){return{op:"do_delete",params:{node_id:a.id}}},getTitleInstance:function(a){return{op:"do_title",params:{node_id:a.id,title:a.title.replace(/\\/g,"\\\\").replace(/\n/g,"\\n")}}},getToggleInstance:function(a){return{op:"do_toggle",params:{node_id:a.id,
fold:a.fold}}},getImageInstance:function(a){return{op:"do_image",params:{node_id:a.id,image:a.image}}},getNoteInstance:function(a){return{op:"do_note",params:{node_id:a.id,note:a.note}}},getMoveInstance:function(a){return{op:"do_move",params:{parent_id:a.parent.id,node_id:a.id,index:a.index,putright:a.putright?"1":"0"}}}});pie.mindmap.Node=Class.create({initialize:function(a,b){this.log=function(){};a=a||{};Object.extend(this,a);if(this.maxid!=null){this.root=this;this.map=b;this.map.md5=this.md5}else{this.parent=b;this.root=b.root;this.sub=this.parent==this.root?this:this.parent.sub}this.canvas={};this.branch={};this.putright=this.putright!="0"?true:false;var c=[];this.children.each(function(d,e){var f=new pie.mindmap.Node(d,this);if(e>0){f.prev=c[e-1];c[e-1].next=f}f.index=e;f.left=0;f.top=0;c.push(f)}.bind(this));
this.children=c;this.dirty=true},_getContainerEl:function(){try{if(this.el==null){this.nodeimg={};if(this.image.url){this.image.el=$(Builder.node("img",{src:this.image.url,height:this.image.height,width:this.image.width}));this.nodeimg={el:$(Builder.node("div",{"class":"nodeimg"},this.image.el))}}this.noteicon={};if(this.note!=""&&this.note!="<br>")this.noteicon={el:$(Builder.node("div",{"class":"noteicon"}))};this.nodetitle={el:$(Builder.node("div",{"class":"nodetitle"}))};this.nodetitle.el.update(this._get_formated_title());
this.nodebody={el:$(Builder.node("div",{"class":"nodebody"},[this.nodetitle.el,this.noteicon.el||[]]))};this.el=$(Builder.node("div",{id:this.id,"class":this.root==this?"root":"node",style:"position:absolute"},[this.nodeimg.el||[],this.nodebody.el]));if(!this.fold)this.fold=0;this.folder={id:"f_"+this.id,el:$(Builder.node("div",{"class":this.fold==0?"foldhandler_minus":"foldhandler_plus",style:"position:absolute;"+(this.children.length==0?"display:none;":"")}))};this.content={id:"children_"+this.id,
top:0,el:$(Builder.node("div",{"class":"mindmap-children",style:"position:absolute"}))};this.children.each(function(b){this.content.el.insert(b._getContainerEl())}.bind(this));this.container={id:"c_"+this.id,top:0,el:$(Builder.node("div",{"class":"mindmap-container",style:"position:absolute"},this.maxid!=null?[this.el,this.content.el]:[this.el,this.folder.el,this.content.el]))};this._bindCommonEvents();this.root.map.editmode?this._bindEditEvents():this._bindShowEvents()}}catch(a){alert(a)}return this.container.el},
_get_formated_title:function(){if(/\n|\s|\\/.test(this.title))return this.__format_title(this.title);return this.title.escapeHTML()},__format_title:function(a){return a.escapeHTML().replace(/\n/g,"<br/>").replace(/\s/g,"&nbsp;").replace(/>$/,">&nbsp;")},_cacheDimensions:function(){if(this.width==null){Object.extend(this,this.el.getDimensions());this.children.each(function(a){a._cacheDimensions()}.bind(this))}},_bindCommonEvents:function(){this.el.makeUnselectable();this.el.observe("mouseover",function(){this.el.addClassName(this==
this.root?"root_over":"node_over")}.bind(this)).observe("mouseout",function(){this.el.removeClassName("root_over").removeClassName("node_over")}.bind(this));var a=this.folder.el;a.observe("mouseover",function(){a.addClassName("foldhandler_over")}.bind(this)).observe("mouseout",function(){a.removeClassName("foldhandler_over").removeClassName("foldhandler_down")}.bind(this)).observe("mouseup",function(){a.removeClassName("foldhandler_down")}.bind(this)).observe("mousedown",function(c){c.stop();if(this.root.map.pause)return false;
a.addClassName("foldhandler_down")}.bindAsEventListener(this)).observe("click",this.toggle.bind(this));this.el.observe("click",function(c){this.root.map.editmode&&Event.isLeftClick(c)&&this.root.map._nodeTitleEditor.doEditTitle(this);this.select()}.bind(this)).observe("contextmenu",function(){this.select()}.bind(this));pie.isIE()&&this.root.map.editmode&&this.el.observe("dblclick",function(){this.root.map._nodeTitleEditor.doEditTitle(this)}.bind(this));if(this.root.map.editmode){try{Element.observe($(this.root.map._noteEditor.el),
"focus",function(){this.root.map._nodeNoteEditor.onNoteEditBegin(this)}.bind(this))}catch(b){}this!=this.root&&new pie.drag.PinNode(this)}},_bindShowEvents:function(){this.note!=""&&new Tip(this.el,this.note,{title:this.title,width:400,border:2,borderColor:"#C7C7C7",radius:2,delay:0,stem:"topLeft",closeButton:true,hideOn:{element:"closeButton",event:"click"},hideOthers:true})},_bindEditEvents:function(){this.root.map.nodeMenu.bind(this.el,"bottom",this)},toggle:function(){var a=this.root.map;if(a._pause())return false;
this._toggle();var b=a.opFactory.getToggleInstance(this);a._save(b);this.sub.dirty=true;a.reRank()},_toggle:function(){1==this.fold?this._expand():this._collapse();this.content.el.toggle()},_expand:function(){this.folder.el.className="foldhandler_minus";this.fold=0},_collapse:function(){var a=this.root.map.focus;if(a)for(;a!=this.root;){if(a.parent==this){this.select();break}a=a.parent}this.folder.el.className="foldhandler_plus";this.fold=1},select:function(a){var b=this.root.map;if(this.isOnTitleEditStatus)return false;
if(b.focus){b.focus.isOnTitleEditStatus&&b.title_textarea.blur();b.focus.el.removeClassName("node_selected");b.focus.el.removeClassName("root_selected");b.focus!=this&&b.isOnNoteEditStatus&&b._nodeNoteEditor.onNoteEditEnd()}b.focus=this;this.root==this?this.el.addClassName("root_selected"):this.el.addClassName("node_selected");a||b.__scrollto(this);b.nodeMenu.unload();if(b.editmode)if(this.note==""||this.note=="<br>")pie.isIE()?b._noteEditor.nicInstances[0].setContent(""):b._noteEditor.nicInstances[0].setContent("<br>");
else b._noteEditor.nicInstances[0].setContent(this.note);return this},getPrevCousin:function(){var a=this,b=0;do{for(var c=a;c=c.prev;)if(c.sub.putright==a.sub.putright)break;if(c){for(;b>0;){b--;if(c.children.length>0&&c.fold!=1)c=c.children.last()}return c}b++}while(a=a.parent);return this},getNextCousin:function(){var a=this,b=0;do{for(var c=a;c=c.next;)if(c.sub.putright==a.sub.putright)break;if(c){for(;b>0;){b--;if(c.children.length>0&&c.fold!=1)c=c.children.first()}return c}b++}while(a=a.parent);
return this},createNewSibling:function(){var a=this.root.map;if(a._pause())return false;if(this==this.root)return false;else{var b=this.parent._newChild(this.index),c=a.opFactory.getInsertInstance(b);a._save(c);a.reRank();b.select();new Effect.Pulsate(b.el,{duration:0.4})}},createNewChild:function(){var a=this.root.map;if(!a._pause()){var b=this._newChild();this._expand();var c=a.opFactory.getInsertInstance(b);a._save(c);a.reRank();b.select();new Effect.Pulsate(b.el,{duration:0.4})}},_newChild:function(a){var b=
this==this.root,c={image:{width:null,border:null,url:null,height:null},fold:"0",note:"",children:[],title:"NewSubNode",putright:"1",id:pie.randstr()};if(b)if(this.map.focus.parent==this)c.putright=this.map.focus.putright;c=new pie.mindmap.Node(c,this);c.left=0;c.top=0;var d=c._getContainerEl();if(a!=null){var e=this.children.slice(0,a+1);a=this.children.slice(a+1);c.prev=e.last();c.prev.next=c;c.next=a.first();if(c.next)c.next.prev=c;e.push(c);this.children=e.concat(a);a=b?c.prev.canvas.el:c.prev.container.el;
a.insert({after:d})}else{c.prev=this.children.last();this.children.push(c);a=this.content.el;a.insert({bottom:d})}c._cacheDimensions();this.children.each(function(f,g){f.index=g}.bind(this));b||this.folder.el.show();c.sub.dirty=true;return c},remove:function(){if(this.root.map._pause()||this==this.root)return false;var a=this.parent;this.container.el.remove();a.children=a.children.without(this);a.__tidyChildren();if(a.children.length==0){if(a!=this.root){a.content.el.hide();a.folder.el.hide();a.select()}}else this.next?
this.next.select():this.prev.select();if(a==this.root){this.canvas.el.remove();this.free||this.branch.el.remove()}this.root.map._save(this.root.map.opFactory.getDeleteInstance(this));this.sub.dirty=true;this.root.map.reRank()},__tidyChildren:function(){this.children.each(function(a,b){a.index=b;a.prev=b>0?this.children[b-1]:null;a.next=b<this.children.length-1?this.children[b+1]:null;a.container.top=0}.bind(this))},__changesub:function(a){this.sub.dirty=true;this.sub=a;this.children.each(function(b){b.__changesub(a)}.bind(this));
this.sub.dirty=true},hilight:function(a){this.nodebody.el.setStyle({backgroundColor:a})}});pie.mindmap.JSONLoader=Class.create({initialize:function(a){a=a||{};this.url=a.url;this.json={}},request:function(a){new Ajax.Request(this.url+".js",{method:"get",onSuccess:a.bind(this)})},load:function(){this.request(function(a){a=a.responseText.evalJSON();this.mindmap.root=new pie.mindmap.Node(a,this.mindmap);this.mindmap._load()}.bind(this))}});pie.mindmap_canvas_draw_module={connect:{},_connectWithDiv:function(){},_drawOnCanvas:function(a){a.canvas.el=$(a.canvas.id);var b=a.canvas.el.getContext("2d");b.strokeStyle=this.lineColor;this._connectWithCanvas_recursion(a,b)},_connectWithCanvas_recursion:function(a,b){var c=this.__getNodePosition(a);b.beginPath();b.moveTo(c.left,c.bottom);b.lineTo(c.right,c.bottom);b.stroke();a.fold!=1&&a.children.each(function(d){this._connectWithCanvas_recursion(d,b);b.beginPath();b.moveTo(c.right,c.bottom);
b.bezierCurveTo(c.right,c.bottom,c.right,d.canvas.bottom,d.canvas.left,d.canvas.bottom);b.stroke()}.bind(this))},__getNodePosition:function(a){var b=a.top.round(),c=b+a.height,d,e;d=a.sub.putright?a.left:a.right;e=d+a.width+this.fw/2;if(a.sub!=a){var f=a.parent.content,g=a.container.top+a.parent.canvas.top-(a.parent.top-f.top).round();b+=g;c+=g;f=a.sub.putright?f.left+a.parent.canvas.left:f.right+a.container.width-a.parent.canvas.left;d+=f;e+=f}if(!a.sub.putright){d=a.container.width-d;e=a.container.width-
e}a.canvas.top=b;a.canvas.bottom=c;a.canvas.left=d;a.canvas.right=e;return{top:b,right:e,bottom:c,left:d}},_drawOnBranch:function(a){if(!a.free){a.branch.el=$(a.branch.id);var b=a.branch.el.getContext("2d");b.fillStyle=this.lineColor;b.strokeStyle=this.lineColor;this._connect_root_with_canvas(a,b)}},_connect_root_with_canvas:function(a,b){try{var c=pie.mindmap,d=a.branch.type==0;(new (a.sub.putright?d?c.RootBranchCanvasRUP:c.RootBranchCanvasRDOWN:d?c.RootBranchCanvasLUP:c.RootBranchCanvasLDOWN)(a,
b)).draw()}catch(e){alert(e)}}};
pie.mindmap.RootBranchCanvasBase=Class.create({initialize:function(a,b){this.map=a.root.map;this.branch=a.branch;this.ctx=b;this.lw=5;this.p2=Math.PI*2;this.rr=2;this.cr=this.map.cr;this.qcoff=a.sub.putright?this.branch.width/3:-this.branch.width/3},draw:function(){this._count_point();var a=this.ctx;a.beginPath();this._draw_connect_line(a);a.stroke();a.fill();a.beginPath();this._draw_arc(a);a.fill()},_draw_connect_line:function(a){a.moveTo(this.x1,this.y1);a.quadraticCurveTo(this.xn-this.qcoff,this.yn,
this.xn,this.yn);a.quadraticCurveTo(this.xn-this.qcoff,this.yn,this.x2,this.y1)},_draw_arc:function(a){a.arc(this.xn,this.yn,this.rr,0,this.p2,true)}});pie.mindmap.RootBranchCanvasRUP=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=0;this.x2=this.lw;this.y1=this.branch.height+this.cr;this.xn=this.branch.width-this.rr;this.yn=this.cr}});
pie.mindmap.RootBranchCanvasRDOWN=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=0;this.x2=this.lw;this.y1=this.cr;this.xn=this.branch.width-this.rr;this.yn=this.branch.height+this.cr}});pie.mindmap.RootBranchCanvasLUP=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=this.branch.width;this.x2=this.branch.width-this.lw;this.y1=this.branch.height+this.cr;this.xn=this.rr;this.yn=this.cr}});
pie.mindmap.RootBranchCanvasLDOWN=Class.create(pie.mindmap.RootBranchCanvasBase,{_count_point:function(){this.x1=this.branch.width;this.x2=this.branch.width-this.lw;this.y1=this.cr;this.xn=this.rr;this.yn=this.branch.height+this.cr}});pie.mindmap_menu_module={_createMenu:function(){try{this.nodeMenu=new pie.mindmap.Menu({observer:this.paper.el,afterload:function(){this.__scrollto(this.nodeMenu)}.bind(this)});this.nodeMenu.addItem("\u65b0\u589e\u3000\u3000 [Ins]",{handler:function(){this.focus.createNewChild()}.bind(this)});this.nodeMenu.addItem("\u5220\u9664\u3000\u3000 [Del]",{handler:function(){this.focus.remove()}.bind(this),flag:function(){return this.focus!=this.root}.bind(this)});this.nodeMenu.addItem("\u7f16\u8f91\u6807\u9898 [\u7a7a\u683c]",
{handler:function(){this._nodeTitleEditor.doEditTitle(this.focus)}.bind(this)});this.nodeMenu.addItem("\u8282\u70b9\u56fe\u7247 [I]",{handler:function(){this._nodeImageEditor.doEditImage(this.focus)}.bind(this)});this.nodeMenu.addItem("\u79fb\u9664\u56fe\u7247",{handler:function(){this._nodeImageEditor.doRemoveImage(this.focus)}.bind(this),flag:function(){return this.focus.image.url}.bind(this)});this.nodeMenu.addItem("\u7f16\u8f91\u5907\u6ce8",{handler:function(){this._noteEditor.el.focus()}.bind(this)})}catch(a){alert(a)}}};pie.mindmap_save_module={_save:function(a){if(this.editmode)if(this.id!="demo"){a!=null&&this.opQueue.push(a);if(this.ready_to_request){a="map="+this.id+"&md5="+this.md5+"&operations="+encodeURIComponent(this.opQueue.toJSON());new Ajax.Request("/mindmaps/do",{parameters:a,method:"PUT",onCreate:function(){this.ready_to_request=false;this.show_notice_info("\u6b63\u5728\u81ea\u52a8\u4fdd\u5b58...");this.opQueue=[]}.bind(this),onSuccess:function(b){this.md5=b.responseText.evalJSON().md5;this.ready_to_request=
true;this.close_info();this.opQueue.length>0&&this._save()}.bind(this),onFailure:function(){this.__on_save_error()}.bind(this)})}}},__on_save_error:function(){this.show_error_info("\u6570\u636e\u4fdd\u5b58\u5931\u8d25").pulsate();this.lock_mindmap();var a=Builder.node("div",{},[Builder.node("h3",{"class":"f_box"},"\u6570\u636e\u4fdd\u5b58\u5931\u8d25"),Builder.node("div",{"class":"mindmap_save_error"},[Builder.node("div",{},"\u7531\u4e8e\u7f51\u7edc\u539f\u56e0\uff0c\u5bfc\u56fe\u4fdd\u5b58\u5931\u8d25\u3002"),
Builder.node("a",{href:"/mindmaps/"+this.id+"/edit"},"\u8bf7\u70b9\u51fb\u8fd9\u91cc\u91cd\u65b0\u8f7d\u5165\u3002"),Builder.node("div",{},"\u6216\u624b\u52a8\u5237\u65b0\u9875\u9762")])]);jQuery.facebox(a);jQuery("#facebox_overlay").unbind("click")},lock_mindmap:function(){if(!this.lock_whiteboard)this.lock_whiteboard=new pie.mindmap.LockWhiteBoard(this);this.lock_whiteboard.show()},show_notice_info:function(a){this._build_info_label();this.save_status_label.notice(a);return this.save_status_label},
show_error_info:function(a){this._build_info_label();this.save_status_label.error(a);return this.save_status_label},close_info:function(){setTimeout(function(){this.save_status_label.fade()}.bind(this),1E3)},_build_info_label:function(){if(!this.save_status_label)this.save_status_label=new pie.mindmap.InfoLabel(this)}};
pie.mindmap.InfoLabel=Class.create({initialize:function(a){try{this.map=a;this._build_dom()}catch(b){alert(b)}},_build_dom:function(){var a=this.map.observer.el.parentNode;this.el=Builder.node("div",{"class":"info-label",style:"display:none;"},"");Element.insert(a,this.el)},pulsate:function(){new Effect.Pulsate(this.el,{pulses:50,duration:60,from:1,to:0.2})},fade:function(){$(this.el).fade({duration:0.2});return this},show:function(a){this.el.innerHTML=a;$(this.el).appear({duration:0.2});return this},
notice:function(a){$(this.el).addClassName("notice");this.show(a);return this},error:function(a){$(this.el).addClassName("error");this.show(a);return this},clear:function(){$(this.el).removeClassName("notice").removeClassName("success").removeClassName("error");return this}});
pie.mindmap.LockWhiteBoard=Class.create({initialize:function(a){try{this.map=a;this._build_dom()}catch(b){alert(b)}},_build_dom:function(){this.el=Builder.node("div",{"class":"lock-white-board",style:"display:none;"});$(this.el).setStyle({opacity:0.6});Element.insert(this.map.paper.el,this.el)},show:function(){var a=this.map.paper.el;$(this.el).clonePosition(a,{setLeft:false,setTop:false}).show()}});pie.mindmap=pie.mindmap||{};
pie.mindmap.BasicMapPaper=Class.create({initialize:function(a,b){b=b||{};Object.extend(this,b);this.paper={id:a,el:$(a)};this.observer={el:$(this.paper.el.parentNode)};this.loader.mindmap=this;this.log=function(){};this.pausePeriod=500;this.fw=11;this.cr=6;this.mr=3;this.mr2=this.mr*2;this.lineColor=b.lineColor||"#5c5c5c";if(this.editmode=b.editmode||false){this._nodeTitleEditor=new pie.mindmap.NodeTitleEditor;this._nodeImageEditor=new pie.mindmap.NodeImageEditor;this._nodeNoteEditor=new pie.mindmap.NoteHandler;
this._nodeFontEditor=new pie.mindmap.NodeFontEditor;this._noteEditor=(new nicEditor({fullPanel:true})).panelInstance("mindmap-note-edit");this._noteEditor.el=pie.isIE()||pie.isChrome()?this._noteEditor.nicInstances[0].elm:this._noteEditor.nicInstances[0].elm.firstChild.contentWindow}this.connect=this._connectWithCanvas;this.focus=this.el=this.root=null;this.opFactory=new pie.mindmap.OperationRecordFactory({map:this});this.opQueue=[];this.ready_to_request=true;this.after_load=b.after_load},load:function(){this.loader.load();
return this},_load:function(){this._createMenu();var a=new Date;this.paper.el.update(this._getEl());this.root._cacheDimensions();var b=new Date;this.log("\u751f\u6210HTML.."+(b-a)+"ms");a=new Date;b=this.paper.el.getDimensions();this.paper.xoff=b.width/2;this.paper.yoff=b.height/2;Object.extend(this.observer,this.observer.el.getDimensions());this.observer.el.scrollLeft=this.paper.xoff;this.observer.el.scrollTop=this.paper.yoff;this.root.posX=(this.observer.width-this.root.width)/2+this.paper.xoff;
this.root.posY=(this.observer.height-this.root.height)/2+this.paper.yoff;this.root.container.el.style.left=this.root.posX+"px";this.root.container.el.style.top=this.root.posY+"px";b=new Date;this.log("\u521d\u59cb\u5316.."+(b-a)+"ms");this.reRank();new pie.drag.Page(this.paper.el,{beforeDrag:function(){this.nodeMenu.unload();this.focus&&this.focus.isOnTitleEditStatus&&this.title_textarea.blur()}.bind(this)});this.after_load()},_getEl:function(){if(this.el==null){this.el=this.root._getContainerEl();
this._bindGlobalCommonEvents();this.editmode?this._bindGlobalEditEvents():this._bindGlobalShowEvents();this._bindHotkeyDispatcher()}return this.el},__prepare_canvas_for_ie:function(){typeof G_vmlCanvasManager!="undefined"&&G_vmlCanvasManager.init_(document)},reRank:function(){var a=new Date;this.root.children.each(function(c){c.dirty&&this.setCoord(c)}.bind(this));this.setRootCoord(this.root);var b=new Date;this.log("\u6392\u5217.."+(b-a)+"ms");a=new Date;this.root.children.each(function(c){c.dirty&&
this.connect(c);this._connectWithCanvas_branch(c)}.bind(this));this.__prepare_canvas_for_ie();this.root.el.style.zIndex="101";this.root.children.each(function(c){if(c.dirty){this._drawOnCanvas(c);c.dirty=false}this._drawOnBranch(c)}.bind(this));b=new Date;this.log("\u753b\u7ebf.."+(b-a)+"ms");this.posRegister=this._updatePosRegister(this.root)},setCoord:function(a){var b=this.fw,c=0,d=0;a.fold!=1?a.children.each(function(m){c+=this.setCoord(m);m=m.container.width;if(m>d)d=m}.bind(this)):Element.hide(a.content.el);
var e=a.width,f=a.height,g=a.container,h=a.content,j=a.folder,i=0;i=0;var k,l;if(c==0){i=f;a.top=0;h.top=0}else if(f>c){k=a.children.first();i=a.children.last().container;l=a.children.last();k=k.top+k.height;i=i.top+l.top+l.height;i=f-(k+i)/2;h.top=i;a.top=0;i=i+c}else if(f<c){k=a.children.first();i=a.children.last().container;l=a.children.last();k=k.top+k.height;i=i.top+l.top+l.height;i=(k+i)/2-f;h.top=0;a.top=i>0?i:0;i=c}else{i=c;a.top=0;h.top=0}h.height=c;h.width=d;if(a.sub.putright){h.left=e+
b;j.left=e;h.el.style.left=h.left+"px";j.el.style.left=j.left+"px";h.el.style.right="";j.el.style.right="";a.el.style.right="";g.el.style.right=""}else{h.right=e+b;j.right=e;a.right=0;g.right=0;h.el.style.right=h.right+"px";j.el.style.right=j.right+"px";a.el.style.right=a.right+"px";g.el.style.right=g.right+"px";h.el.style.left="";j.el.style.left=""}j.top=f-b/2+a.top;g.height=i;g.width=e+b+a.content.width;if(b=a.prev){b.container||this.log(b.title+"****");if(a.parent!=this.root){g.top=b.container.top+
b.container.height+10;i+=10}else if(a.free){g.el.style.left=a.freeX+"px";g.top=b.container.top+b.container.height-a.top+10;g.el.style.top=a.freeY-a.top+"px"}}g.el.style.height=g.height+"px";g.el.style.width=g.width+"px";if(a.free!=true)g.el.style.top=g.top+"px";h.el.style.height=h.height+"px";h.el.style.width=h.width+"px";h.el.style.top=h.top+"px";j.el.style.top=j.top+"px";a.el.style.top=a.top+"px";return i},setRootCoord:function(a){Element.makeUnselectable(a.el);a.top=a.el.offsetTop;a.left=a.el.offsetLeft;
var b=a.left+(a.width+50),c=-10,d=-10;a.children.each(function(j){if(!j.free){var i=j.container;if(j.putright){i.left=b;c+=i.height+10}else{i.left=a.left*2+a.width-b-i.width;d+=i.height+10}i.el.style.left=i.left+"px"}}.bind(this));var e=a.height,f=a.top,g=f-(c-e)/2,h=f-(d-e)/2;a.children.each(function(j){var i=j.container;if(!j.free){if(j.putright){i.top=g;g+=i.height+10}else{i.top=h;h+=i.height+10}i.el.style.top=i.top+"px"}j=j.canvas;j.el&&j.el.clonePosition(i.el,{setWidth:false,setHeight:false})}.bind(this))},
_connectWithCanvas:function(a){var b=a.canvas.el;if(!b){Element.setStyle(a.container.el,{zIndex:"101"});a.canvas.id="canvas_"+a.id;b=Builder.node("canvas",{id:a.canvas.id});$(b).setStyle({zIndex:"100",position:"absolute",border:"solid 0px"});Element.insert(a.container.el,{after:b});b.clonePosition(a.container.el,{setWidth:false,setHeight:false})}a.canvas.width=a.container.width;a.canvas.height=a.container.height+this.cr;b.setAttribute("width",a.canvas.width);b.setAttribute("height",a.canvas.height)},
_connectWithCanvas_branch:function(a){if(a.free){if(a.branch.el){Element.remove(a.branch.el);a.branch={}}}else{this.__countBranch(a);var b=a.branch.el;if(!b){a.branch.id="branch_"+a.id;b=Builder.node("canvas",{id:a.branch.id});$(b).setStyle({zIndex:"100",position:"absolute",border:"solid 0px"});a.container.el.insert({after:b})}b.setAttribute("width",a.branch.width);b.setAttribute("height",a.branch.height+this.cr*2);b.setStyle({left:a.branch.left+"px",top:a.branch.top-this.cr*2+"px"})}},__countBranch:function(a){if(a.sub.putright){a.branch.left=
a.root.left+a.root.width/2;a.branch.width=a.container.left-a.branch.left}else{a.branch.left=a.container.left+a.container.width;a.branch.width=a.root.left+a.root.width/2-a.branch.left}if(a.container.top+a.top+a.height<a.root.top+a.root.height/2){a.branch.top=(a.container.top+a.top+a.height).round();a.branch.height=a.root.top+a.root.height/2-a.branch.top;a.branch.type=0}else{a.branch.top=a.root.top+a.root.height/2;a.branch.height=(a.container.top+a.top+a.height-a.branch.top).round();a.branch.type=1}a.branch.top+=
this.cr},_updatePosRegister:function(a){$A(document.getElementsByName("postemp")).each(Element.remove);var b=new Hash,c=a.left+this.root.posX,d=a.top+this.root.posY;b.set(a.id,[a,c,d,c+a.width,d+a.height]);a.children.each(function(e){this._updatePosRegister_recursion(e,b)}.bind(this));return b},_updatePosRegister_recursion:function(a,b){var c,d,e,f;d=a.canvas.top+a.sub.container.top-a.top+this.root.posY;e=a.width;f=a.container.height;c=a.canvas.left+a.sub.container.left+this.root.posX;a.sub.putright||
(c-=a.width);b.set(a.id,[a,c,d,c+e,d+f]);1!=a.fold&&a.children.each(function(g){this._updatePosRegister_recursion(g,b)}.bind(this))},__setTempBox:function(a,b,c,d){this.posbox=Builder.node("div",{name:"postemp",style:"position:absolute; background-color:#E8641B;border-top:solid 5px #DF0024;border-bottom:solid 5px #DF0024;"});Element.setStyle(this.posbox,{left:a+"px",top:b+"px",width:c+"px",height:d+"px",opacity:0.3,zIndex:103});this.root.map.paper.el.appendChild(this.posbox)},_bindGlobalCommonEvents:function(){},
_bindGlobalShowEvents:function(){this.paper.el.observe("mousedown",function(){Tips.hideAll()})},_bindGlobalEditEvents:function(){},_bindHotkeyDispatcher:function(){document.stopObserving("keydown",window._hotkeyDispatcher);window._hotkeyDispatcher=this.hotkeyDispatcher.bind(this);document.observe("keydown",window._hotkeyDispatcher)},hotkeyDispatcher:function(a){if(!this.focus||this.focus.isOnTitleEditStatus)return false;var b=Event.element(a).tagName;if(pie.isIE()){this.log(b);if(b!="DIV")return false}else if(b!=
"HTML"&&b!="BODY")return false;b=a.keyCode;if(!this.isOnNoteEditStatus){Event.stop(a);switch(b){case Event.KEY_UP:this._up();break;case Event.KEY_DOWN:this._down();break;case Event.KEY_LEFT:this._left();break;case Event.KEY_RIGHT:this._right();break}if(this.editmode)switch(b){case Event.KEY_RETURN:this.focus.createNewSibling();break;case 45:this.focus.createNewChild();break;case 46:this.focus.remove();break;case 32:this._nodeTitleEditor.doEditTitle(this.focus);break;case 73:this._nodeImageEditor.doEditImage(this.focus);
break}}},_up:function(){var a=this.focus;if(a!=a.root){a.getPrevCousin().select();this.log("up:"+a.id)}else a.children.each(function(b){if(b.putright){b.select();throw $break;}}.bind(this))},_down:function(){var a=this.focus;if(a!=a.root){a.getNextCousin().select();this.log("down:"+a.id)}else a.children.reverse(false).each(function(b){if(b.putright){b.select();throw $break;}}.bind(this))},_left:function(){var a=this.focus;if(a!=a.root)if(a.sub.putright){a.parent.select();this.log("left:"+a.id)}else{if(1!=
a.fold)if(a.children.first()){a.children[((0+a.children.length-1)/2).floor()].select();this.log("left:"+a.id)}}else a.children.each(function(b){if(!b.putright){b.select();throw $break;}}.bind(this))},_right:function(){var a=this.focus;if(a!=a.root)if(a.sub.putright){if(1!=a.fold)if(a.children.first()){a.children[((0+a.children.length-1)/2).floor()].select();this.log("left:"+a.id)}}else{a.parent.select();this.log("left:"+a.id)}else a.children.each(function(b){if(b.putright){b.select();throw $break;
}}.bind(this))},__scrollto:function(a){if(!a.el.visible())return false;Object.extend(this.observer,this.observer.el.getDimensions());var b,c,d,e=this.observer.el,f=e.cumulativeOffset(),g=a.el.cumulativeOffset();b=e.scrollLeft;c=e.scrollTop;d=g[0]-b-f[0];var h=g[1]-c-f[1];if(d<0){d=g[0]-f[0];new Effect.Tween(e,b,d,{duration:0.4},"scrollLeft")}else{d+=a.width-this.observer.width+22;if(d>0){d=g[0]-f[0]-this.observer.width+a.width+22;new Effect.Tween(e,b,d,{duration:0.4},"scrollLeft")}}if(h<0){a=g[1]-
f[1];new Effect.Tween(e,c,a,{duration:0.4},"scrollTop")}else{h+=a.height-this.observer.height+22;if(h>0){a=g[1]-f[1]-this.observer.height+a.height+22;new Effect.Tween(e,c,a,{duration:0.4},"scrollTop")}}},_pause:function(a){if(this.pause==true)return true;else{this.pause=true;a=a||this.pausePeriod;setTimeout(function(){this.pause=false}.bind(this),a);return false}}});pie.mindmap.BasicMapPaper.addMethods(pie.mindmap_canvas_draw_module).addMethods(pie.mindmap_menu_module).addMethods(pie.mindmap_save_module);
